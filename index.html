<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fitness Coach">
    <meta name="theme-color" content="#1a202c">
    <title>Fitness Coach AI</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --accent: #ed8936;
            --accent-light: #fbd38d;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #fc8181;
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* Splash Screen */
        .splash {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .splash.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .splash-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .splash-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .splash-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .splash-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            padding: 0.5rem;
            gap: 0.25rem;
        }

        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .nav-btn.active {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Screens */
        .screen {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* Chat Screen */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 85%;
            padding: 0.875rem 1rem;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .message.user {
            background: var(--accent);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: var(--bg-secondary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Markdown styling in messages */
        .message.assistant h1, .message.assistant h2, .message.assistant h3 {
            margin: 0.5rem 0;
            color: var(--accent);
        }

        .message.assistant h1 { font-size: 1.2rem; }
        .message.assistant h2 { font-size: 1.1rem; }
        .message.assistant h3 { font-size: 1rem; }

        .message.assistant ul, .message.assistant ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .message.assistant li {
            margin: 0.25rem 0;
        }

        .message.assistant strong {
            color: var(--accent-light);
        }

        .message.assistant code {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .message.assistant pre {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message.assistant pre code {
            background: none;
            padding: 0;
        }

        .message.assistant p {
            margin: 0.5rem 0;
        }

        .message.assistant p:first-child {
            margin-top: 0;
        }

        .message.assistant p:last-child {
            margin-bottom: 0;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
            align-self: flex-start;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input-container {
            padding: 1rem;
            background: var(--bg-secondary);
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 20px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .send-btn svg {
            fill: white;
            width: 20px;
            height: 20px;
        }

        /* Dashboard */
        .dashboard {
            padding: 1rem;
            overflow-y: auto;
        }

        .countdown-card {
            background: linear-gradient(135deg, var(--accent) 0%, #dd6b20 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .countdown-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .countdown-value {
            font-size: 3rem;
            font-weight: 700;
        }

        .countdown-event {
            font-size: 1rem;
            opacity: 0.9;
        }

        .countdown-date {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .quick-action {
            background: var(--bg-secondary);
            border: none;
            border-radius: 12px;
            padding: 1rem 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .quick-action svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-unit {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-trend {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stat-trend.up {
            color: var(--success);
        }

        .knee-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .knee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .knee-title {
            font-weight: 600;
        }

        .knee-status {
            display: flex;
            gap: 0.5rem;
        }

        .knee-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .knee-dot.green { background: var(--success); }
        .knee-dot.yellow { background: var(--warning); }
        .knee-dot.red { background: var(--danger); }

        .knee-dot.active {
            border-color: white;
            transform: scale(1.2);
        }

        .knee-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Training Screen */
        .training-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .training-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .training-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .add-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
        }

        .activity-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .activity-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-icon {
            font-size: 1.25rem;
        }

        .activity-name {
            font-weight: 600;
        }

        .activity-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .activity-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Nutrition Screen */
        .nutrition-screen {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .calorie-card {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .calorie-ring {
            width: 150px;
            height: 150px;
            margin: 0 auto 1rem;
            position: relative;
        }

        .calorie-ring svg {
            transform: rotate(-90deg);
        }

        .calorie-ring-bg {
            fill: none;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 12;
        }

        .calorie-ring-progress {
            fill: none;
            stroke: white;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 408;
            stroke-dashoffset: 408;
            transition: stroke-dashoffset 0.5s;
        }

        .calorie-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .calorie-remaining {
            font-size: 2rem;
            font-weight: 700;
        }

        .calorie-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .calorie-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
        }

        .calorie-item {
            text-align: center;
        }

        .calorie-item-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .calorie-item-label {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .macros-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .macros-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .macro-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .macro-label {
            width: 80px;
            font-size: 0.875rem;
        }

        .macro-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 0.75rem;
        }

        .macro-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .macro-bar-fill.protein { background: #ed8936; }
        .macro-bar-fill.carbs { background: #4299e1; }
        .macro-bar-fill.fat { background: #9f7aea; }

        .macro-value {
            font-size: 0.875rem;
            width: 60px;
            text-align: right;
        }

        .meal-input-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .meal-input-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .meal-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 80px;
            margin-bottom: 0.75rem;
        }

        .meal-textarea::placeholder {
            color: var(--text-secondary);
        }

        .analyze-btn {
            width: 100%;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .meals-list {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .meals-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .meal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .meal-item:last-child {
            border-bottom: none;
        }

        .meal-info {
            flex: 1;
        }

        .meal-name {
            font-size: 0.9rem;
        }

        .meal-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .meal-kcal {
            font-weight: 600;
            color: var(--accent);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }

        .modal-header h2 {
            font-size: 1.125rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-content {
            padding: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .form-section {
            margin-bottom: 1.5rem;
        }

        .form-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Knee Modal */
        .knee-modal-content {
            text-align: center;
            padding: 1rem;
        }

        .knee-options {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .knee-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .knee-option-dot {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .knee-option-dot.green { background: var(--success); }
        .knee-option-dot.yellow { background: var(--warning); }
        .knee-option-dot.red { background: var(--danger); }

        .knee-option.active .knee-option-dot {
            border-color: white;
            transform: scale(1.1);
        }

        .knee-option-label {
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Splash Screen -->
        <div class="splash" id="splash">
            <div class="splash-logo">üèÉ‚Äç‚ôÇÔ∏è</div>
            <div class="splash-title">Fitness Coach AI</div>
            <div class="splash-subtitle">Dein pers√∂nlicher Laufcoach</div>
            <button class="splash-btn" onclick="hideSplash()">Los geht's</button>
        </div>

        <!-- Header -->
        <header class="header">
            <h1 class="header-title">Fitness Coach</h1>
            <button class="header-btn" onclick="openSettings()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </header>

        <!-- Chat Screen -->
        <div class="screen active" id="screen-chat">
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    Hallo! üëã Ich bin dein KI-Fitness-Coach. Wie kann ich dir heute helfen?
                </div>
            </div>
            <div class="chat-input-container">
                <textarea
                    class="chat-input"
                    id="chat-input"
                    placeholder="Nachricht eingeben..."
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="screen-dashboard">
            <div class="dashboard">
                <!-- Countdown -->
                <div class="countdown-card">
                    <div class="countdown-label">Tage bis Madrid</div>
                    <div class="countdown-value" id="countdown-days">49</div>
                    <div class="countdown-event">üá™üá∏ Halbmarathon Madrid</div>
                    <div class="countdown-date" id="countdown-date">22. M√§rz 2026</div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action" onclick="logKneeStatus()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Knie-Check
                    </button>
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Was steht heute auf dem Plan?')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Tagesplan
                    </button>
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Wie sollte ich mich heute ern√§hren?')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        Ern√§hrung
                    </button>
                </div>

                <!-- Week Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Diese Woche</div>
                        <div class="stat-value" id="week-km">0 <span class="stat-unit">km</span></div>
                        <div class="stat-trend up" id="week-trend">Ziel: 22-25 km</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktuelle Woche</div>
                        <div class="stat-value" id="current-week">1</div>
                        <div class="stat-trend" id="week-phase">Aufbau I</div>
                    </div>
                </div>

                <!-- Knee Status -->
                <div class="knee-card">
                    <div class="knee-header">
                        <div class="knee-title">ü¶µ Knie-Status heute</div>
                        <div class="knee-status">
                            <div class="knee-dot green" id="knee-green" onclick="setKneeStatus('green')"></div>
                            <div class="knee-dot yellow" id="knee-yellow" onclick="setKneeStatus('yellow')"></div>
                            <div class="knee-dot red" id="knee-red" onclick="setKneeStatus('red')"></div>
                        </div>
                    </div>
                    <div class="knee-info" id="knee-info">Tippe auf eine Farbe um deinen Status zu aktualisieren</div>
                </div>
            </div>
        </div>

        <!-- Training Screen -->
        <div class="screen" id="screen-training">
            <div class="training-list">
                <div class="training-header">
                    <h2 class="training-title">Aktivit√§ten</h2>
                    <button class="add-btn" onclick="openActivityModal()">+</button>
                </div>
                <div id="activities-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>Noch keine Aktivit√§ten</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Verbinde Strava oder f√ºge manuell hinzu</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutrition Screen -->
        <div class="screen" id="screen-nutrition">
            <div class="nutrition-screen">
                <!-- Calorie Overview -->
                <div class="calorie-card">
                    <div class="calorie-ring">
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <circle class="calorie-ring-bg" cx="75" cy="75" r="65"/>
                            <circle class="calorie-ring-progress" id="calorie-progress" cx="75" cy="75" r="65"/>
                        </svg>
                        <div class="calorie-center">
                            <div class="calorie-remaining" id="calories-remaining">2100</div>
                            <div class="calorie-label">√ºbrig</div>
                        </div>
                    </div>
                    <div class="calorie-breakdown">
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-base">2100</div>
                            <div class="calorie-item-label">Grundumsatz</div>
                        </div>
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-activity">+0</div>
                            <div class="calorie-item-label">Aktivit√§t</div>
                        </div>
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-food">-0</div>
                            <div class="calorie-item-label">Gegessen</div>
                        </div>
                    </div>
                </div>

                <!-- Macros -->
                <div class="macros-card">
                    <div class="macros-title">Makros</div>
                    <div class="macro-row">
                        <span class="macro-label">Protein</span>
                        <div class="macro-bar">
                            <div class="macro-bar-fill protein" id="protein-bar" style="width: 0%"></div>
                        </div>
                        <span class="macro-value" id="protein-value">0/120g</span>
                    </div>
                    <div class="macro-row">
                        <span class="macro-label">Kohlenhydr.</span>
                        <div class="macro-bar">
                            <div class="macro-bar-fill carbs" id="carbs-bar" style="width: 0%"></div>
                        </div>
                        <span class="macro-value" id="carbs-value">0/250g</span>
                    </div>
                    <div class="macro-row">
                        <span class="macro-label">Fett</span>
                        <div class="macro-bar">
                            <div class="macro-bar-fill fat" id="fat-bar" style="width: 0%"></div>
                        </div>
                        <span class="macro-value" id="fat-value">0/70g</span>
                    </div>
                </div>

                <!-- Meal Input -->
                <div class="meal-input-card">
                    <div class="meal-input-title">üçΩÔ∏è Was hast du gegessen?</div>
                    <textarea
                        class="meal-textarea"
                        id="meal-input"
                        placeholder="z.B.: Fr√ºhst√ºck: 2 Scheiben Vollkornbrot mit K√§se, 1 Apfel, Kaffee mit Milch..."
                    ></textarea>
                    <button class="analyze-btn" onclick="analyzeMeal()">Mit KI analysieren</button>
                </div>

                <!-- Today's Meals -->
                <div class="meals-list">
                    <div class="meals-title">Heute gegessen</div>
                    <div id="meals-today">
                        <div class="empty-state" style="padding: 1rem;">
                            <p style="font-size: 0.875rem; color: var(--text-secondary);">Noch nichts eingetragen</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" onclick="showScreen('chat')" id="nav-chat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Chat
            </button>
            <button class="nav-btn" onclick="showScreen('dashboard')" id="nav-dashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Dashboard
            </button>
            <button class="nav-btn" onclick="showScreen('training')" id="nav-training">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                Training
            </button>
            <button class="nav-btn" onclick="showScreen('nutrition')" id="nav-nutrition">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                    <line x1="6" y1="1" x2="6" y2="4"></line>
                    <line x1="10" y1="1" x2="10" y2="4"></line>
                    <line x1="14" y1="1" x2="14" y2="4"></line>
                </svg>
                Ern√§hrung
            </button>
        </nav>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Einstellungen</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-content">
                <div class="form-section">
                    <div class="form-section-title">üîë API Einstellungen</div>
                    <div class="form-group">
                        <label class="form-label">Claude API Key</label>
                        <input type="password" class="form-input" id="api-key-input" placeholder="sk-ant-...">
                        <p class="form-hint">Hol dir deinen Key auf console.anthropic.com</p>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üéØ Ziel</div>
                    <div class="form-group">
                        <label class="form-label">Zielzeit Halbmarathon</label>
                        <input type="text" class="form-input" id="goal-time-input" placeholder="1:59:59" value="1:59:59">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Renndatum</label>
                        <input type="date" class="form-input" id="race-date-input" value="2026-03-22">
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ü§ñ Coach-Pers√∂nlichkeit</div>
                    <div class="form-group">
                        <label class="form-label">Expertenrolle & Kontext</label>
                        <textarea class="form-textarea" id="coach-persona-input" placeholder="z.B.: Du bist ein erfahrener Laufcoach mit Fokus auf Verletzungspr√§vention..."></textarea>
                        <p class="form-hint">Beschreibe, wie der Coach sich verhalten soll</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zus√§tzliche Infos √ºber dich</label>
                        <textarea class="form-textarea" id="user-context-input" placeholder="z.B.: Ich arbeite im B√ºro, stehe um 6 Uhr auf, trainiere am liebsten abends..."></textarea>
                        <p class="form-hint">Je mehr Kontext, desto bessere Tipps</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tonalit√§t</label>
                        <select class="form-input" id="tone-select">
                            <option value="motivierend">Motivierend & Positiv</option>
                            <option value="sachlich">Sachlich & Direkt</option>
                            <option value="freundlich">Freundlich & Locker</option>
                            <option value="streng">Streng & Fordernd</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üçé Ern√§hrung</div>
                    <div class="form-group">
                        <label class="form-label">T√§glicher Kalorienbedarf (kcal)</label>
                        <input type="number" class="form-input" id="calorie-goal-input" value="2100">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
                <button class="btn btn-secondary" onclick="closeSettings()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Add Activity Modal -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Aktivit√§t hinzuf√ºgen</h2>
                <button class="modal-close" onclick="closeActivityModal()">√ó</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Aktivit√§tstyp</label>
                    <select class="form-input" id="activity-type">
                        <option value="run">üèÉ Lauf</option>
                        <option value="bike">üö¥ Radfahren</option>
                        <option value="swim">üèä Schwimmen</option>
                        <option value="strength">üí™ Krafttraining</option>
                        <option value="mobility">üßò Mobility/Yoga</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" class="form-input" id="activity-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Distanz (km)</label>
                    <input type="number" step="0.1" class="form-input" id="activity-distance" placeholder="z.B. 5.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Dauer (Minuten)</label>
                    <input type="number" class="form-input" id="activity-duration" placeholder="z.B. 30">
                </div>
                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-textarea" id="activity-notes" placeholder="Wie hast du dich gef√ºhlt?"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveActivity()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Knee Status Modal -->
    <div class="modal-overlay" id="knee-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Knie-Status</h2>
                <button class="modal-close" onclick="closeKneeModal()">√ó</button>
            </div>
            <div class="knee-modal-content">
                <p>Wie f√ºhlt sich dein Knie heute an?</p>
                <div class="knee-options">
                    <div class="knee-option" onclick="selectKneeOption('green')">
                        <div class="knee-option-dot green"></div>
                        <span class="knee-option-label">Alles OK</span>
                    </div>
                    <div class="knee-option" onclick="selectKneeOption('yellow')">
                        <div class="knee-option-dot yellow"></div>
                        <span class="knee-option-label">Leichte Beschwerden</span>
                    </div>
                    <div class="knee-option" onclick="selectKneeOption('red')">
                        <div class="knee-option-dot red"></div>
                        <span class="knee-option-label">Schmerzen</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="confirmKneeStatus()">Best√§tigen</button>
            </div>
        </div>
    </div>

    <script>
        // State
        const state = {
            apiKey: localStorage.getItem('apiKey') || '',
            goalTime: localStorage.getItem('goalTime') || '1:59:59',
            raceDate: localStorage.getItem('raceDate') || '2026-03-22',
            activities: JSON.parse(localStorage.getItem('activities') || '[]'),
            kneeStatus: localStorage.getItem('kneeStatus') || 'green',
            messages: JSON.parse(localStorage.getItem('messages') || '[]'),
            hasSeenSplash: localStorage.getItem('hasSeenSplash') === 'true',
            coachPersona: localStorage.getItem('coachPersona') || '',
            userContext: localStorage.getItem('userContext') || '',
            tone: localStorage.getItem('tone') || 'motivierend',
            calorieGoal: parseInt(localStorage.getItem('calorieGoal')) || 2100,
            meals: JSON.parse(localStorage.getItem('meals') || '[]'),
            selectedKnee: null
        };

        // Helper functions
        function formatDate(date) {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            return `${days[date.getDay()]}, ${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatShortDate(date) {
            return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth()+1).toString().padStart(2, '0')}.`;
        }

        function getWeekNumber() {
            const raceDate = new Date(state.raceDate);
            const today = new Date();
            const diffTime = raceDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const totalWeeks = 7; // 7-week plan
            const weeksUntilRace = Math.ceil(diffDays / 7);
            return Math.max(1, totalWeeks - weeksUntilRace + 1);
        }

        function getWeekPhase(weekNum) {
            if (weekNum <= 2) return 'Aufbau I';
            if (weekNum <= 4) return 'Aufbau II';
            if (weekNum <= 5) return 'Peak';
            if (weekNum === 6) return 'Tapering';
            return 'Rennwoche';
        }

        // Generate date-based training context
        function generateTrainingContext() {
            const today = new Date();
            const raceDate = new Date(state.raceDate);
            const daysUntilRace = Math.ceil((raceDate - today) / (1000 * 60 * 60 * 24));
            const weeksUntilRace = Math.ceil(daysUntilRace / 7);
            const currentWeek = getWeekNumber();
            const dayOfWeek = today.getDay(); // 0 = Sunday

            // Get tone description
            const toneMap = {
                'motivierend': 'Sei motivierend, positiv und ermutigend. Feiere Erfolge und hilf bei R√ºckschl√§gen.',
                'sachlich': 'Sei sachlich und direkt. Fokussiere auf Fakten und konkrete Zahlen.',
                'freundlich': 'Sei freundlich und locker. Nutze eine entspannte Sprache.',
                'streng': 'Sei streng und fordernd. Push mich zu H√∂chstleistungen.'
            };

            // Generate this week's training dates
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1); // Monday

            const trainingDays = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                trainingDays.push(formatShortDate(date));
            }

            let context = `Du bist ein KI-Fitness-Coach f√ºr Fabian, der sich auf seinen Halbmarathon in Madrid am 22. M√§rz 2026 vorbereitet.

HEUTE IST: ${formatDate(today)}
TAGE BIS ZUM RENNEN: ${daysUntilRace}
AKTUELLE TRAININGSWOCHE: ${currentWeek} von 7 (${getWeekPhase(currentWeek)})

WICHTIGE INFOS √úBER FABIAN:
- Hat eine Teilruptur am vorderen Kreuzband (VKB) und war 3 Monate pausiert
- Ist seit 2-4 Wochen wieder im Training
- Erster Comeback-Lauf: 7 km mit leichten Beschwerden (Kniebandage)
- Vor der Verletzung: Hobby-L√§ufer (15-30 km/Woche)
- Ziel: Sub 2:00h (ambitioniert, realistischer w√§re 2:10-2:20)
- Verwendet: Garmin Forerunner 255, Strava, Fitbod
${state.userContext ? `- Zus√§tzlicher Kontext: ${state.userContext}` : ''}

AKTUELLER STATUS:
- Knie-Status heute: ${state.kneeStatus === 'green' ? 'Gr√ºn (OK)' : state.kneeStatus === 'yellow' ? 'Gelb (Vorsicht)' : 'Rot (Pause!)'}

TRAININGSPLAN WOCHE ${currentWeek} (${trainingDays[0]} - ${trainingDays[6]}):
- Mo ${trainingDays[0]}: ${currentWeek <= 2 ? 'Ruhe' : '30 min locker'}
- Di ${trainingDays[1]}: 30 min locker + 15 min Kraft (Beine)
- Mi ${trainingDays[2]}: Ruhe / Mobility
- Do ${trainingDays[3]}: 35 min locker
- Fr ${trainingDays[4]}: Ruhe
- Sa ${trainingDays[5]}: ${currentWeek <= 4 ? '40 min locker (Flach!)' : currentWeek === 5 ? '50 min mit Tempoeinheit' : '30 min locker'}
- So ${trainingDays[6]}: Schwimmen/Rad 45 min
- Wochenziel: ${currentWeek <= 2 ? '15-18' : currentWeek <= 4 ? '22-25' : currentWeek === 5 ? '28-32' : '15-20'} km

KNIE-PROTOKOLL:
- GR√úN: Plan wie vorgesehen
- GELB: Tempo/Distanz reduzieren, Alternativtraining erw√§gen
- ROT: Sofort stoppen, 2 Tage Pause, ggf. Arzt

${state.coachPersona ? `DEINE ROLLE: ${state.coachPersona}` : ''}

DEIN VERHALTEN:
- ${toneMap[state.tone] || toneMap['motivierend']}
- Priorisiere IMMER die Gesundheit des Knies
- Erinnere an Arztbesuch wenn relevant
- Gib konkrete, umsetzbare Tipps
- Antworte auf Deutsch
- Halte Antworten pr√§gnant (max 3-4 S√§tze, au√üer bei detaillierten Fragen)
- Formatiere l√§ngere Antworten mit Markdown (√úberschriften, Listen, **fett**)`;

            return context;
        }

        // Update countdown
        function updateCountdown() {
            const raceDate = new Date(state.raceDate);
            const today = new Date();
            const diffTime = raceDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            document.getElementById('countdown-days').textContent = diffDays;
            document.getElementById('countdown-date').textContent = formatDate(raceDate);

            // Update week info
            const currentWeek = getWeekNumber();
            document.getElementById('current-week').textContent = currentWeek;
            document.getElementById('week-phase').textContent = getWeekPhase(currentWeek);
        }

        // Update knee display
        function updateKneeDisplay() {
            document.querySelectorAll('.knee-dot').forEach(dot => dot.classList.remove('active'));
            document.getElementById(`knee-${state.kneeStatus}`).classList.add('active');

            const infoMap = {
                green: '‚úÖ Alles OK - Training wie geplant',
                yellow: '‚ö†Ô∏è Vorsicht - Reduziertes Training empfohlen',
                red: 'üõë Pause - Kein Training heute'
            };
            document.getElementById('knee-info').textContent = infoMap[state.kneeStatus];
        }

        // Load messages
        function loadMessages() {
            const container = document.getElementById('chat-messages');
            if (state.messages.length > 0) {
                // Keep welcome message, add saved messages
                state.messages.forEach(msg => {
                    addMessageToUI(msg.role, msg.content, false);
                });
            }
        }

        // Add message to UI
        function addMessageToUI(role, content, save = true) {
            const container = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;

            // Parse markdown for assistant messages
            if (role === 'assistant') {
                msgDiv.innerHTML = parseMarkdown(content);
            } else {
                msgDiv.textContent = content;
            }

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;

            if (save) {
                state.messages.push({ role, content });
                localStorage.setItem('messages', JSON.stringify(state.messages.slice(-20))); // Keep last 20
            }
        }

        // Simple markdown parser
        function parseMarkdown(text) {
            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Code blocks
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // Inline code
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');

            // Lists
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[123]>)/g, '$1');
            html = html.replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');

            return html;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing');
            if (indicator) indicator.remove();
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';
            addMessageToUI('user', message);

            if (!state.apiKey) {
                addMessageToUI('assistant', 'Bitte gib zuerst deinen Claude API Key in den Einstellungen ein (‚öôÔ∏è oben rechts).');
                return;
            }

            showTypingIndicator();

            try {
                const trainingContext = generateTrainingContext();

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: trainingContext,
                        messages: [
                            ...state.messages.slice(-10).map(m => ({
                                role: m.role === 'assistant' ? 'assistant' : 'user',
                                content: m.content
                            })),
                            { role: 'user', content: message }
                        ]
                    })
                });

                hideTypingIndicator();

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.content[0].text;
                addMessageToUI('assistant', assistantMessage);

            } catch (error) {
                hideTypingIndicator();
                console.error('Error:', error);
                addMessageToUI('assistant', `Fehler: ${error.message}. Bitte √ºberpr√ºfe deinen API Key.`);
            }
        }

        // Analyze meal with AI
        async function analyzeMeal() {
            const input = document.getElementById('meal-input');
            const mealText = input.value.trim();
            if (!mealText) return;

            if (!state.apiKey) {
                alert('Bitte gib zuerst deinen Claude API Key in den Einstellungen ein.');
                return;
            }

            const btn = document.querySelector('.analyze-btn');
            btn.textContent = 'Analysiere...';
            btn.disabled = true;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        system: 'Du bist ein Ern√§hrungsexperte. Analysiere die Mahlzeit und gib die N√§hrwerte zur√ºck. Antworte NUR mit JSON in diesem Format: {"name": "Kurze Beschreibung", "kcal": Zahl, "protein": Zahl, "carbs": Zahl, "fat": Zahl}. Sch√§tze realistisch basierend auf typischen Portionsgr√∂√üen.',
                        messages: [
                            { role: 'user', content: mealText }
                        ]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const mealData = JSON.parse(jsonMatch[0]);
                    mealData.time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    mealData.date = new Date().toISOString().split('T')[0];

                    state.meals.push(mealData);
                    localStorage.setItem('meals', JSON.stringify(state.meals));

                    input.value = '';
                    updateNutritionDisplay();
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Fehler bei der Analyse. Bitte versuche es erneut.');
            }

            btn.textContent = 'Mit KI analysieren';
            btn.disabled = false;
        }

        // Update nutrition display
        function updateNutritionDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const todaysMeals = state.meals.filter(m => m.date === today);

            const totals = todaysMeals.reduce((acc, meal) => ({
                kcal: acc.kcal + (meal.kcal || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0)
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

            // Get activity calories (simplified - could be enhanced with Strava data)
            const todaysActivities = state.activities.filter(a => a.date === today);
            const activityKcal = todaysActivities.reduce((sum, a) => sum + (a.duration * 8), 0); // ~8 kcal/min estimate

            const remaining = state.calorieGoal + activityKcal - totals.kcal;

            // Update display
            document.getElementById('calories-remaining').textContent = Math.max(0, remaining);
            document.getElementById('calories-base').textContent = state.calorieGoal;
            document.getElementById('calories-activity').textContent = `+${activityKcal}`;
            document.getElementById('calories-food').textContent = `-${totals.kcal}`;

            // Update progress ring
            const progress = Math.min(totals.kcal / (state.calorieGoal + activityKcal), 1);
            const circumference = 408; // 2 * PI * 65
            document.getElementById('calorie-progress').style.strokeDashoffset = circumference * (1 - progress);

            // Update macros
            const proteinGoal = 120, carbsGoal = 250, fatGoal = 70;
            document.getElementById('protein-bar').style.width = `${Math.min(totals.protein / proteinGoal * 100, 100)}%`;
            document.getElementById('carbs-bar').style.width = `${Math.min(totals.carbs / carbsGoal * 100, 100)}%`;
            document.getElementById('fat-bar').style.width = `${Math.min(totals.fat / fatGoal * 100, 100)}%`;
            document.getElementById('protein-value').textContent = `${totals.protein}/${proteinGoal}g`;
            document.getElementById('carbs-value').textContent = `${totals.carbs}/${carbsGoal}g`;
            document.getElementById('fat-value').textContent = `${totals.fat}/${fatGoal}g`;

            // Update meals list
            const mealsContainer = document.getElementById('meals-today');
            if (todaysMeals.length === 0) {
                mealsContainer.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p style="font-size: 0.875rem; color: var(--text-secondary);">Noch nichts eingetragen</p></div>';
            } else {
                mealsContainer.innerHTML = todaysMeals.map(meal => `
                    <div class="meal-item">
                        <div class="meal-info">
                            <div class="meal-name">${meal.name}</div>
                            <div class="meal-time">${meal.time}</div>
                        </div>
                        <div class="meal-kcal">${meal.kcal} kcal</div>
                    </div>
                `).join('');
            }
        }

        // Handle keyboard input
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(`screen-${screenId}`).classList.add('active');
            document.getElementById(`nav-${screenId}`).classList.add('active');

            if (screenId === 'nutrition') {
                updateNutritionDisplay();
            }
        }

        // Ask coach
        function askCoach(question) {
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        // Splash screen
        function hideSplash() {
            document.getElementById('splash').classList.add('hidden');
            state.hasSeenSplash = true;
            localStorage.setItem('hasSeenSplash', 'true');
        }

        // Settings
        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('goal-time-input').value = state.goalTime;
            document.getElementById('race-date-input').value = state.raceDate;
            document.getElementById('coach-persona-input').value = state.coachPersona;
            document.getElementById('user-context-input').value = state.userContext;
            document.getElementById('tone-select').value = state.tone;
            document.getElementById('calorie-goal-input').value = state.calorieGoal;
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value;
            state.goalTime = document.getElementById('goal-time-input').value;
            state.raceDate = document.getElementById('race-date-input').value;
            state.coachPersona = document.getElementById('coach-persona-input').value;
            state.userContext = document.getElementById('user-context-input').value;
            state.tone = document.getElementById('tone-select').value;
            state.calorieGoal = parseInt(document.getElementById('calorie-goal-input').value) || 2100;

            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('goalTime', state.goalTime);
            localStorage.setItem('raceDate', state.raceDate);
            localStorage.setItem('coachPersona', state.coachPersona);
            localStorage.setItem('userContext', state.userContext);
            localStorage.setItem('tone', state.tone);
            localStorage.setItem('calorieGoal', state.calorieGoal);

            updateCountdown();
            closeSettings();
        }

        // Activity Modal
        function openActivityModal() {
            document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('activity-modal').classList.add('active');
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('active');
        }

        function saveActivity() {
            const activity = {
                type: document.getElementById('activity-type').value,
                date: document.getElementById('activity-date').value,
                distance: parseFloat(document.getElementById('activity-distance').value) || 0,
                duration: parseInt(document.getElementById('activity-duration').value) || 0,
                notes: document.getElementById('activity-notes').value,
                id: Date.now()
            };

            state.activities.unshift(activity);
            localStorage.setItem('activities', JSON.stringify(state.activities));

            updateActivitiesList();
            updateWeekStats();
            closeActivityModal();
        }

        // Update activities list
        function updateActivitiesList() {
            const container = document.getElementById('activities-list');

            if (state.activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>Noch keine Aktivit√§ten</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Verbinde Strava oder f√ºge manuell hinzu</p>
                    </div>
                `;
                return;
            }

            const typeIcons = {
                run: 'üèÉ',
                bike: 'üö¥',
                swim: 'üèä',
                strength: 'üí™',
                mobility: 'üßò'
            };

            const typeNames = {
                run: 'Lauf',
                bike: 'Radfahren',
                swim: 'Schwimmen',
                strength: 'Krafttraining',
                mobility: 'Mobility'
            };

            container.innerHTML = state.activities.map(a => `
                <div class="activity-card">
                    <div class="activity-header">
                        <div class="activity-type">
                            <span class="activity-icon">${typeIcons[a.type] || 'üèÉ'}</span>
                            <span class="activity-name">${typeNames[a.type] || a.type}</span>
                        </div>
                        <div class="activity-date">${new Date(a.date).toLocaleDateString('de-DE')}</div>
                    </div>
                    <div class="activity-stats">
                        ${a.distance ? `<span class="activity-stat">üìè ${a.distance} km</span>` : ''}
                        ${a.duration ? `<span class="activity-stat">‚è±Ô∏è ${a.duration} min</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Update week stats
        function updateWeekStats() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1);
            weekStart.setHours(0, 0, 0, 0);

            const weekActivities = state.activities.filter(a => {
                const date = new Date(a.date);
                return date >= weekStart && a.type === 'run';
            });

            const weekKm = weekActivities.reduce((sum, a) => sum + (a.distance || 0), 0);
            document.getElementById('week-km').innerHTML = `${weekKm.toFixed(1)} <span class="stat-unit">km</span>`;
        }

        // Knee status
        function logKneeStatus() {
            document.getElementById('knee-modal').classList.add('active');
        }

        function closeKneeModal() {
            document.getElementById('knee-modal').classList.remove('active');
        }

        function selectKneeOption(status) {
            state.selectedKnee = status;
            document.querySelectorAll('.knee-option').forEach(opt => opt.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function confirmKneeStatus() {
            if (state.selectedKnee) {
                setKneeStatus(state.selectedKnee, true);
            }
            closeKneeModal();
        }

        function setKneeStatus(status, closeModal = true) {
            state.kneeStatus = status;
            localStorage.setItem('kneeStatus', status);
            updateKneeDisplay();

            if (closeModal) {
                closeKneeModal();
            }

            // Give feedback based on status
            if (status === 'red') {
                showScreen('chat');
                setTimeout(() => {
                    askCoach('Mein Knie schmerzt heute (rot). Was soll ich tun?');
                }, 300);
            } else if (status === 'yellow') {
                showScreen('chat');
                setTimeout(() => {
                    askCoach('Mein Knie f√ºhlt sich heute etwas komisch an (gelb). Soll ich trotzdem trainieren?');
                }, 300);
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW:', err));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (state.hasSeenSplash) {
                document.getElementById('splash').classList.add('hidden');
            }
            updateCountdown();
            updateKneeDisplay();
            loadMessages();
            updateActivitiesList();
            updateWeekStats();
            updateNutritionDisplay();

            // Auto-resize textarea
            const input = document.getElementById('chat-input');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            });
        });
    </script>
</body>
</html>
