<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fitness Coach">
    <meta name="theme-color" content="#1a202c">
    <title>Fitness Coach AI</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --accent: #ed8936;
            --accent-light: #fbd38d;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #fc8181;
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
        }
        html { height: -webkit-fill-available; }
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* Splash Screen */
        .splash {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .splash.hidden { opacity: 0; visibility: hidden; }
        .splash-logo { font-size: 4rem; margin-bottom: 1rem; }
        .splash-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .splash-subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .splash-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
        }
        .header-title { font-size: 1.25rem; font-weight: 600; }
        .header-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            padding: 0.5rem;
            gap: 0.25rem;
            flex-shrink: 0; /* WICHTIG: Nav darf nicht schrumpfen! */
            position: relative;
            z-index: 100;
        }
        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        .nav-btn.active { background: var(--bg-tertiary); color: var(--accent); }
        .nav-btn svg { width: 24px; height: 24px; }

        /* Screens */
        .screen { display: none; flex: 1; overflow: hidden; }
        .screen.active { display: flex; flex-direction: column; }

        /* Chat Screen */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        .message-container.user { align-self: flex-end; }
        .message-container.assistant { align-self: flex-start; }
        .message {
            padding: 0.875rem 1rem;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 0.95rem;
            position: relative;
        }
        .message.user {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            background: var(--bg-secondary);
            border-bottom-left-radius: 4px;
        }
        .message.assistant h1, .message.assistant h2, .message.assistant h3 { margin: 0.5rem 0; color: var(--accent); }
        .message.assistant h1 { font-size: 1.2rem; }
        .message.assistant h2 { font-size: 1.1rem; }
        .message.assistant h3 { font-size: 1rem; }
        .message.assistant ul, .message.assistant ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .message.assistant li { margin: 0.25rem 0; }
        .message.assistant strong { color: var(--accent-light); }
        .message.assistant code { background: var(--bg-tertiary); padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.85em; }
        .message.assistant pre { background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; overflow-x: auto; margin: 0.5rem 0; }
        .message.assistant pre code { background: none; padding: 0; }
        .message.assistant p { margin: 0.5rem 0; }
        .message.assistant p:first-child { margin-top: 0; }
        .message.assistant p:last-child { margin-bottom: 0; }

        .message-delete {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            opacity: 0.5;
            transition: opacity 0.2s;
            align-self: flex-end;
            margin-top: 0.25rem;
        }
        .message-delete:hover { opacity: 1; color: var(--danger); }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
            align-self: flex-start;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input-container {
            padding: 1rem;
            background: var(--bg-secondary);
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 20px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
        }
        .chat-input::placeholder { color: var(--text-secondary); }
        .send-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .send-btn svg { fill: white; width: 20px; height: 20px; }

        /* Dashboard */
        .dashboard { padding: 1rem; overflow-y: auto; }
        .countdown-card {
            background: linear-gradient(135deg, var(--accent) 0%, #dd6b20 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .countdown-label { font-size: 0.875rem; opacity: 0.9; }
        .countdown-value { font-size: 3rem; font-weight: 700; }
        .countdown-event { font-size: 1rem; opacity: 0.9; }
        .countdown-date { font-size: 0.8rem; opacity: 0.7; margin-top: 0.25rem; }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .quick-action {
            background: var(--bg-secondary);
            border: none;
            border-radius: 12px;
            padding: 1rem 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .quick-action svg { width: 24px; height: 24px; stroke: var(--accent); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .stat-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-value { font-size: 1.5rem; font-weight: 600; }
        .stat-unit { font-size: 0.875rem; color: var(--text-secondary); }
        .stat-trend { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-trend.up { color: var(--success); }

        .knee-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .knee-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .knee-title { font-weight: 600; }
        .knee-status { display: flex; gap: 0.5rem; }
        .knee-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .knee-dot.green { background: var(--success); }
        .knee-dot.yellow { background: var(--warning); }
        .knee-dot.red { background: var(--danger); }
        .knee-dot.active { border-color: white; transform: scale(1.15); }
        .knee-info { font-size: 0.875rem; color: var(--text-secondary); }

        /* Training Screen */
        .training-list { flex: 1; overflow-y: auto; padding: 1rem; }
        .training-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .training-title { font-size: 1.25rem; font-weight: 600; }
        .add-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
        }
        .activity-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; }
        .activity-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .activity-type { display: flex; align-items: center; gap: 0.5rem; }
        .activity-icon { font-size: 1.25rem; }
        .activity-name { font-weight: 600; }
        .activity-date { font-size: 0.75rem; color: var(--text-secondary); }
        .activity-stats { display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
        .activity-stat { display: flex; align-items: center; gap: 0.25rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        /* Strava Connect */
        .strava-connect {
            background: #fc4c02;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Nutrition Screen */
        .nutrition-screen { flex: 1; overflow-y: auto; padding: 1rem; }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 0.75rem;
        }
        .date-nav-btn {
            background: var(--bg-tertiary);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .date-nav-current { font-weight: 600; min-width: 140px; text-align: center; }
        .date-nav-today {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .calorie-card {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .calorie-ring { width: 150px; height: 150px; margin: 0 auto 1rem; position: relative; }
        .calorie-ring svg { transform: rotate(-90deg); }
        .calorie-ring-bg { fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 12; }
        .calorie-ring-progress { fill: none; stroke: white; stroke-width: 12; stroke-linecap: round; stroke-dasharray: 408; stroke-dashoffset: 408; transition: stroke-dashoffset 0.5s; }
        .calorie-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .calorie-remaining { font-size: 2rem; font-weight: 700; }
        .calorie-label { font-size: 0.75rem; opacity: 0.8; }
        .calorie-breakdown { display: flex; justify-content: space-around; margin-top: 1rem; }
        .calorie-item { text-align: center; }
        .calorie-item-value { font-size: 1.25rem; font-weight: 600; }
        .calorie-item-label { font-size: 0.7rem; opacity: 0.8; }

        .macros-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .macros-title { font-weight: 600; margin-bottom: 0.75rem; }
        .macro-row { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .macro-label { width: 80px; font-size: 0.875rem; }
        .macro-bar { flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin: 0 0.75rem; }
        .macro-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .macro-bar-fill.protein { background: #ed8936; }
        .macro-bar-fill.carbs { background: #4299e1; }
        .macro-bar-fill.fat { background: #9f7aea; }
        .macro-value { font-size: 0.875rem; width: 70px; text-align: right; }

        .meal-input-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .meal-input-title { font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .meal-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 60px;
        }
        .meal-textarea::placeholder { color: var(--text-secondary); }
        .meal-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .analyzing-indicator { display: flex; align-items: center; gap: 0.5rem; color: var(--accent); font-size: 0.875rem; margin-top: 0.5rem; }
        .analyzing-indicator.hidden { display: none; }

        .meals-list { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .meals-title { font-weight: 600; margin-bottom: 0.75rem; }
        .meal-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--bg-tertiary); }
        .meal-item:last-child { border-bottom: none; }
        .meal-info { flex: 1; }
        .meal-name { font-size: 0.9rem; }
        .meal-time { font-size: 0.75rem; color: var(--text-secondary); }
        .meal-kcal { font-weight: 600; color: var(--accent); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }
        .modal-header h2 { font-size: 1.125rem; }
        .modal-close { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        .modal-content { padding: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-input { width: 100%; background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; }
        .form-textarea { width: 100%; background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 0.9rem; resize: vertical; min-height: 100px; font-family: inherit; }
        .form-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .form-section { margin-bottom: 1.5rem; }
        .form-section-title { font-weight: 600; margin-bottom: 0.75rem; color: var(--accent); }
        .btn { width: 100%; padding: 0.875rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; margin-bottom: 0.5rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-size: 0.9rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            border-left: 3px solid var(--success);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.error {
            border-left-color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Splash Screen -->
        <div class="splash" id="splash">
            <div class="splash-logo">üèÉ‚Äç‚ôÇÔ∏è</div>
            <div class="splash-title">Fitness Coach AI</div>
            <div class="splash-subtitle">Dein pers√∂nlicher Laufcoach</div>
            <button class="splash-btn" onclick="hideSplash()">Los geht's</button>
        </div>

        <!-- Header -->
        <header class="header">
            <h1 class="header-title">Fitness Coach</h1>
            <button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </header>

        <!-- Chat Screen -->
        <div class="screen active" id="screen-chat">
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chat-input" placeholder="Nachricht eingeben..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="screen-dashboard">
            <div class="dashboard">
                <div class="countdown-card">
                    <div class="countdown-label">Tage bis Madrid</div>
                    <div class="countdown-value" id="countdown-days">48</div>
                    <div class="countdown-event">üá™üá∏ Halbmarathon Madrid</div>
                    <div class="countdown-date" id="countdown-date">22. M√§rz 2026</div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Was steht heute auf meinem Trainingsplan?')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Tagesplan
                    </button>
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Erstelle mir einen angepassten Wochenplan!')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Wochenplan
                    </button>
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Analysiere meine letzten Trainings und gib mir Feedback!')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        Analyse
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">üèÉ Lauf-km diese Woche</div>
                        <div class="stat-value" id="week-km">0 <span class="stat-unit">km</span></div>
                        <div class="stat-trend" id="week-trend">aus Strava</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚è±Ô∏è Aktivit√§t diese Woche</div>
                        <div class="stat-value" id="month-km">0 <span class="stat-unit">min</span></div>
                        <div class="stat-trend" id="month-trend">alle Sportarten</div>
                    </div>
                </div>

                <div class="knee-card">
                    <div class="knee-header">
                        <div class="knee-title">ü¶µ Knie-Status heute</div>
                        <div class="knee-status">
                            <div class="knee-dot green" onclick="setKneeStatus('green')"></div>
                            <div class="knee-dot yellow" onclick="setKneeStatus('yellow')"></div>
                            <div class="knee-dot red" onclick="setKneeStatus('red')"></div>
                        </div>
                    </div>
                    <div class="knee-info" id="knee-info">Tippe auf eine Farbe um deinen Status zu aktualisieren</div>
                </div>
            </div>
        </div>

        <!-- Training Screen -->
        <div class="screen" id="screen-training">
            <div class="training-list">
                <div class="training-header">
                    <h2 class="training-title">Aktivit√§ten</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="add-btn" onclick="syncStrava()" id="strava-sync-btn" style="background: #fc4c02; font-size: 1rem; display: none;">üîÑ</button>
                        <button class="add-btn" onclick="openActivityModal()">+</button>
                    </div>
                </div>

                <!-- Activity Filters -->
                <div class="activity-filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    <select id="filter-type" onchange="updateActivitiesList()" style="background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.8rem;">
                        <option value="all">Alle Typen</option>
                        <option value="run">Lauf</option>
                        <option value="bike">Radfahren</option>
                        <option value="swim">Schwimmen</option>
                        <option value="strength">Krafttraining</option>
                        <option value="mobility">Mobility</option>
                        <option value="walk">Gehen</option>
                        <option value="crosstrainer">Crosstrainer</option>
                        <option value="padel">Padel</option>
                        <option value="basketball">Basketball</option>
                    </select>
                    <select id="filter-period" onchange="updateActivitiesList()" style="background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.8rem;">
                        <option value="all">Alle Zeit</option>
                        <option value="week">Diese Woche</option>
                        <option value="month">Diesen Monat</option>
                        <option value="3months">Letzte 3 Monate</option>
                        <option value="6months">Letzte 6 Monate</option>
                        <option value="year">Dieses Jahr</option>
                    </select>
                </div>

                <div id="activities-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>Noch keine Aktivit√§ten</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Verbinde Strava um deine L√§ufe zu importieren</p>
                        <button class="strava-connect" onclick="connectStrava()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                            Mit Strava verbinden
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutrition Screen -->
        <div class="screen" id="screen-nutrition">
            <div class="nutrition-screen">
                <!-- Date Navigation -->
                <div class="date-nav">
                    <button class="date-nav-btn" onclick="changeNutritionDate(-1)">‚Äπ</button>
                    <div class="date-nav-current" id="nutrition-date">Heute</div>
                    <button class="date-nav-btn" onclick="changeNutritionDate(1)" id="date-nav-next">‚Ä∫</button>
                    <button class="date-nav-today" onclick="goToNutritionToday()">Heute</button>
                </div>

                <div class="calorie-card">
                    <div class="calorie-ring">
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <circle class="calorie-ring-bg" cx="75" cy="75" r="65"/>
                            <circle class="calorie-ring-progress" id="calorie-progress" cx="75" cy="75" r="65"/>
                        </svg>
                        <div class="calorie-center">
                            <div class="calorie-remaining" id="calories-remaining">2100</div>
                            <div class="calorie-label">√ºbrig</div>
                        </div>
                    </div>
                    <div class="calorie-breakdown">
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-base">2100</div>
                            <div class="calorie-item-label">Grundumsatz</div>
                        </div>
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-activity">+0</div>
                            <div class="calorie-item-label">Aktivit√§t</div>
                        </div>
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-food">-0</div>
                            <div class="calorie-item-label">Gegessen</div>
                        </div>
                    </div>
                </div>

                <div class="macros-card">
                    <div class="macros-title">Makros</div>
                    <div class="macro-row">
                        <span class="macro-label">Protein</span>
                        <div class="macro-bar"><div class="macro-bar-fill protein" id="protein-bar" style="width: 0%"></div></div>
                        <span class="macro-value" id="protein-value">0/175g</span>
                    </div>
                    <div class="macro-row">
                        <span class="macro-label">Kohlenhydr.</span>
                        <div class="macro-bar"><div class="macro-bar-fill carbs" id="carbs-bar" style="width: 0%"></div></div>
                        <span class="macro-value" id="carbs-value">0/250g</span>
                    </div>
                    <div class="macro-row">
                        <span class="macro-label">Fett</span>
                        <div class="macro-bar"><div class="macro-bar-fill fat" id="fat-bar" style="width: 0%"></div></div>
                        <span class="macro-value" id="fat-value">0/70g</span>
                    </div>
                </div>

                <div class="meal-input-card" id="meal-input-card">
                    <div class="meal-input-title">üçΩÔ∏è Was hast du gegessen?</div>
                    <textarea class="meal-textarea" id="meal-input" placeholder="Einfach eintippen, z.B.: 2 Eier, Toast, Kaffee mit Milch" onkeydown="handleMealKeyDown(event)" onblur="handleMealBlur()"></textarea>
                    <div class="meal-hint">Dr√ºcke Enter oder tippe fertig - wird automatisch analysiert</div>
                    <div class="analyzing-indicator hidden" id="analyzing-indicator">
                        <span class="typing-indicator" style="padding: 0;"><span></span><span></span><span></span></span>
                        Analysiere...
                    </div>
                </div>

                <div class="meals-list">
                    <div class="meals-title" id="meals-title">Heute gegessen</div>
                    <div id="meals-today">
                        <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Noch nichts eingetragen</div>
                    </div>
                </div>

                <!-- Weekly Summary -->
                <div class="macros-card" id="weekly-summary" style="margin-top: 1rem;">
                    <div class="macros-title">üìä Wochenbilanz (Mo-So)</div>
                    <div id="weekly-summary-content" style="font-size: 0.85rem; color: var(--text-secondary);">
                        Lade...
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" onclick="showScreen('chat')" id="nav-chat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                Chat
            </button>
            <button class="nav-btn" onclick="showScreen('dashboard')" id="nav-dashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Dashboard
            </button>
            <button class="nav-btn" onclick="showScreen('training')" id="nav-training">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                Training
            </button>
            <button class="nav-btn" onclick="showScreen('nutrition')" id="nav-nutrition">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                Ern√§hrung
            </button>
        </nav>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Einstellungen</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-content">
                <div class="form-section">
                    <div class="form-section-title">üîë API & Verbindungen</div>
                    <div class="form-group">
                        <label class="form-label">Claude API Key</label>
                        <input type="password" class="form-input" id="api-key-input" placeholder="sk-ant-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Strava</label>
                        <button class="strava-connect" onclick="connectStrava()" id="strava-btn" style="width: 100%;">
                            Mit Strava verbinden
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üéØ Ziel</div>
                    <div class="form-group">
                        <label class="form-label">Zielzeit Halbmarathon</label>
                        <input type="text" class="form-input" id="goal-time-input" placeholder="1:59:59" value="1:59:59">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Renndatum</label>
                        <input type="date" class="form-input" id="race-date-input" value="2026-03-22">
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ü§ñ Coach-Pers√∂nlichkeit</div>
                    <div class="form-group">
                        <label class="form-label">Zus√§tzliche Infos √ºber dich</label>
                        <textarea class="form-textarea" id="user-context-input" placeholder="z.B.: Ich arbeite im B√ºro, stehe um 6 Uhr auf, trainiere am liebsten abends..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tonalit√§t</label>
                        <select class="form-input" id="tone-select">
                            <option value="motivierend">Motivierend & Positiv</option>
                            <option value="sachlich">Sachlich & Direkt</option>
                            <option value="freundlich">Freundlich & Locker</option>
                            <option value="streng">Streng & Fordernd</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üçé Ern√§hrung</div>
                    <div class="form-group">
                        <label class="form-label">T√§glicher Kalorienbedarf (kcal)</label>
                        <input type="number" class="form-input" id="calorie-goal-input" value="2100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">K√∂rpergewicht (kg) - f√ºr Proteinberechnung</label>
                        <input type="number" class="form-input" id="weight-input" value="87.5">
                        <div class="form-hint">Protein-Ziel: 2g pro kg K√∂rpergewicht</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
                <button class="btn btn-danger" onclick="clearChatHistory()">Chat-Verlauf l√∂schen</button>
                <button class="btn btn-secondary" onclick="closeSettings()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Aktivit√§t hinzuf√ºgen</h2>
                <button class="modal-close" onclick="closeActivityModal()">√ó</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Aktivit√§tstyp</label>
                    <select class="form-input" id="activity-type">
                        <option value="run">üèÉ Lauf</option>
                        <option value="walk">üö∂ Gehen</option>
                        <option value="bike">üö¥ Radfahren</option>
                        <option value="swim">üèä Schwimmen</option>
                        <option value="strength">üí™ Krafttraining</option>
                        <option value="crosstrainer">üèãÔ∏è Crosstrainer</option>
                        <option value="mobility">üßò Mobility/Yoga</option>
                        <option value="padel">üéæ Padel/Tennis</option>
                        <option value="basketball">üèÄ Basketball/Fu√üball</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" class="form-input" id="activity-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Distanz (km)</label>
                    <input type="number" step="0.1" class="form-input" id="activity-distance" placeholder="z.B. 5.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Dauer (Minuten)</label>
                    <input type="number" class="form-input" id="activity-duration" placeholder="z.B. 30">
                </div>
                <div class="form-group">
                    <label class="form-label">Wie hat sich dein Knie angef√ºhlt?</label>
                    <select class="form-input" id="activity-knee">
                        <option value="green">üü¢ Alles OK</option>
                        <option value="yellow">üü° Leichte Beschwerden</option>
                        <option value="red">üî¥ Schmerzen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-textarea" id="activity-notes" placeholder="Wie hast du dich gef√ºhlt?"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveActivity()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // State
        const state = {
            apiKey: localStorage.getItem('apiKey') || '',
            goalTime: localStorage.getItem('goalTime') || '1:59:59',
            raceDate: localStorage.getItem('raceDate') || '2026-03-22',
            activities: JSON.parse(localStorage.getItem('activities') || '[]'),
            kneeStatus: localStorage.getItem('kneeStatus') || 'green',
            kneeHistory: JSON.parse(localStorage.getItem('kneeHistory') || '[]'),
            messages: JSON.parse(localStorage.getItem('messages') || '[]'),
            hasSeenSplash: localStorage.getItem('hasSeenSplash') === 'true',
            userContext: localStorage.getItem('userContext') || '',
            tone: localStorage.getItem('tone') || 'motivierend',
            calorieGoal: parseInt(localStorage.getItem('calorieGoal')) || 2100,
            weight: parseFloat(localStorage.getItem('weight')) || 87.5,
            stravaConnected: localStorage.getItem('stravaConnected') === 'true',
            stravaActivities: JSON.parse(localStorage.getItem('stravaActivities') || '[]'),
            currentNutritionDate: new Date().toISOString().split('T')[0]
        };

        // Computed protein goal (2g per kg)
        function getProteinGoal() {
            return Math.round(state.weight * 2);
        }

        // Helper functions
        function formatDate(date) {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            return `${days[date.getDay()]}, ${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatShortDate(date) {
            return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth()+1).toString().padStart(2, '0')}.`;
        }

        function getDaysUntilRace() {
            const raceDate = new Date(state.raceDate);
            const today = new Date();
            return Math.ceil((raceDate - today) / (1000 * 60 * 60 * 24));
        }

        function getDateKey(dateStr) {
            return `meals_${dateStr}`;
        }

        function getMealsForDate(dateStr) {
            return JSON.parse(localStorage.getItem(getDateKey(dateStr)) || '[]');
        }

        function saveMealsForDate(dateStr, meals) {
            localStorage.setItem(getDateKey(dateStr), JSON.stringify(meals));
        }

        // Toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Generate DYNAMIC training context - NO hardcoded plan!
        function generateTrainingContext() {
            const today = new Date();
            const daysUntilRace = getDaysUntilRace();
            const weeksUntilRace = Math.ceil(daysUntilRace / 7);

            // Get recent activities for context
            const recentActivities = [...state.activities, ...state.stravaActivities]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            const activitiesSummary = recentActivities.length > 0
                ? recentActivities.map(a => {
                    const date = new Date(a.date).toLocaleDateString('de-DE');
                    const type = a.type || 'run';
                    const dist = a.distance ? `${a.distance}km` : '';
                    const dur = a.duration ? `${a.duration}min` : '';
                    const knee = a.kneeStatus ? `(Knie: ${a.kneeStatus})` : '';
                    return `- ${date}: ${type} ${dist} ${dur} ${knee}`.trim();
                }).join('\n')
                : 'Noch keine Aktivit√§ten aufgezeichnet.';

            // Calculate weekly stats
            const thisWeekStart = new Date(today);
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            thisWeekStart.setDate(today.getDate() - diff);
            thisWeekStart.setHours(0,0,0,0);

            const thisWeekActivities = [...state.activities, ...state.stravaActivities]
                .filter(a => new Date(a.date) >= thisWeekStart && a.type === 'run');
            const thisWeekKmRaw = thisWeekActivities.reduce((sum, a) => {
                const dist = parseFloat(a.distance);
                return sum + (isNaN(dist) ? 0 : dist);
            }, 0);
            const thisWeekKm = isNaN(thisWeekKmRaw) ? 0 : thisWeekKmRaw;

            // Knee history
            const kneeHistorySummary = state.kneeHistory.slice(-7).map(k =>
                `${new Date(k.date).toLocaleDateString('de-DE')}: ${k.status}`
            ).join(', ') || 'Keine Historie';

            // Tone mapping
            const toneMap = {
                'motivierend': 'Sei motivierend und positiv. Feiere Erfolge!',
                'sachlich': 'Sei sachlich und direkt. Fokus auf Fakten.',
                'freundlich': 'Sei freundlich und locker.',
                'streng': 'Sei streng und fordernd. Push mich!'
            };

            return `Du bist ein erfahrener KI-Laufcoach spezialisiert auf Comeback nach Verletzungen.

HEUTE: ${formatDate(today)}
ZIEL: Halbmarathon Madrid am 22. M√§rz 2026 (in ${daysUntilRace} Tagen / ${weeksUntilRace} Wochen)
ZIELZEIT: ${state.goalTime} (ambitioniert nach Verletzung)

WICHTIG √úBER DEN ATHLETEN (Fabian):
- Teilruptur vorderes Kreuzband (VKB), war 3 Monate pausiert
- Comeback-Phase: Erst seit wenigen Wochen wieder im Training
- Vor Verletzung: Hobby-L√§ufer mit 15-30 km/Woche
- Ausr√ºstung: Garmin Forerunner 255, nutzt Strava
${state.userContext ? `- Zus√§tzlicher Kontext: ${state.userContext}` : ''}

‚ö†Ô∏è AKTUELLER KNIE-STATUS: ${state.kneeStatus === 'green' ? 'üü¢ GR√úN (OK)' : state.kneeStatus === 'yellow' ? 'üü° GELB (Vorsicht!)' : 'üî¥ ROT (Pause!)'}
Knie-Verlauf letzte Tage: ${kneeHistorySummary}

üìä TRAININGSHISTORIE:
Diese Woche bisher: ${(Number(thisWeekKm) || 0).toFixed(1)} km
Letzte Aktivit√§ten:
${activitiesSummary}

üéØ DEINE AUFGABE:
1. Erstelle INDIVIDUELLE Trainingspl√§ne basierend auf den ECHTEN Aktivit√§ten oben
2. Passe SOFORT an den Knie-Status an:
   - GR√úN: Normales Training m√∂glich
   - GELB: Reduziere Intensit√§t/Umfang um 30-50%, empfehle Alternativen (Schwimmen, Rad)
   - ROT: NUR Pause, Mobility, ggf. Arztbesuch empfehlen
3. Ber√ºcksichtige die bisherige Belastung der Woche
4. Sei realistisch: Nach VKB-Teilruptur ist Vorsicht wichtiger als Tempo

üçΩÔ∏è ERN√ÑHRUNG HEUTE (${today.toLocaleDateString('de-DE')}):
${generateNutritionContext()}

KOMMUNIKATIONSSTIL:
${toneMap[state.tone]}
- Antworte auf Deutsch
- Formatiere mit Markdown (### √úberschriften, **fett**, Listen)
- Halte Antworten kompakt aber hilfreich`;
        }

        // Generate nutrition context for chat
        function generateNutritionContext() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todaysMeals = getMealsForDate(todayStr);

            if (todaysMeals.length === 0) {
                return 'Noch nichts gegessen heute.';
            }

            const totals = todaysMeals.reduce((acc, meal) => ({
                kcal: acc.kcal + (meal.kcal || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0)
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

            const proteinGoal = getProteinGoal();
            const activityKcal = [...state.activities, ...state.stravaActivities]
                .filter(a => a.date === todayStr)
                .reduce((sum, a) => sum + (a.calories || (parseInt(a.duration) || 0) * 10), 0);

            const totalBudget = state.calorieGoal + activityKcal;
            const remaining = totalBudget - totals.kcal;

            let mealsList = todaysMeals.map(m => `- ${m.time}: ${m.name} (${m.kcal} kcal, ${m.protein}g Protein)`).join('\n');

            return `${mealsList}
SUMME: ${totals.kcal}/${totalBudget} kcal (noch ${remaining} kcal √ºbrig)
PROTEIN: ${totals.protein}/${proteinGoal}g (${Math.round(totals.protein/proteinGoal*100)}% erreicht)
${totals.protein < proteinGoal * 0.5 ? '‚ö†Ô∏è Protein-Defizit! Empfehle proteinreiche Mahlzeit.' : totals.protein >= proteinGoal ? '‚úÖ Protein-Ziel erreicht!' : ''}`;
        }

        // Update countdown
        function updateCountdown() {
            const daysUntilRace = getDaysUntilRace();
            document.getElementById('countdown-days').textContent = daysUntilRace;
            document.getElementById('countdown-date').textContent = formatDate(new Date(state.raceDate));
        }

        // Update knee display
        function updateKneeDisplay() {
            document.querySelectorAll('.knee-dot').forEach(dot => dot.classList.remove('active'));
            document.querySelector(`.knee-dot.${state.kneeStatus}`).classList.add('active');

            const infoMap = {
                green: '‚úÖ Alles OK - Training m√∂glich',
                yellow: '‚ö†Ô∏è Vorsicht - Reduziertes Training empfohlen',
                red: 'üõë Pause - Kein Lauftraining heute!'
            };
            document.getElementById('knee-info').textContent = infoMap[state.kneeStatus];
        }

        // Set knee status with history tracking
        function setKneeStatus(status) {
            const oldStatus = state.kneeStatus;
            state.kneeStatus = status;
            localStorage.setItem('kneeStatus', status);

            // Save to history
            const today = new Date().toISOString().split('T')[0];
            const existingToday = state.kneeHistory.findIndex(k => k.date === today);
            if (existingToday >= 0) {
                state.kneeHistory[existingToday].status = status;
            } else {
                state.kneeHistory.push({ date: today, status });
            }
            localStorage.setItem('kneeHistory', JSON.stringify(state.kneeHistory.slice(-30)));

            updateKneeDisplay();

            // If status changed to yellow/red, offer advice
            if (status !== 'green' && status !== oldStatus) {
                showScreen('chat');
                setTimeout(() => {
                    const msg = status === 'yellow'
                        ? 'Mein Knie f√ºhlt sich heute nicht 100% an (gelb). Was empfiehlst du f√ºr heute?'
                        : 'Mein Knie schmerzt heute (rot). Was soll ich tun?';
                    askCoach(msg);
                }, 300);
            }
        }

        // Load messages
        function loadMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';

            // Add welcome message if no messages
            if (state.messages.length === 0) {
                addMessageToUI('assistant', 'Hallo! üëã Ich bin dein KI-Fitness-Coach. Ich erstelle dir einen individuellen Trainingsplan basierend auf deinen Strava-Aktivit√§ten und deinem aktuellen Knie-Status. Wie kann ich dir heute helfen?', false);
            } else {
                state.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, false, index));
            }
        }

        // Add message to UI with delete button
        function addMessageToUI(role, content, save = true, index = null) {
            const container = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = `message-container ${role}`;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = role === 'assistant' ? parseMarkdown(content) : escapeHtml(content);
            wrapper.appendChild(msgDiv);

            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'message-delete';
            deleteBtn.textContent = 'L√∂schen';
            const msgIndex = index !== null ? index : state.messages.length;
            deleteBtn.onclick = () => deleteMessage(msgIndex);
            wrapper.appendChild(deleteBtn);

            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;

            if (save) {
                state.messages.push({ role, content });
                localStorage.setItem('messages', JSON.stringify(state.messages.slice(-50)));
            }
        }

        // Delete single message
        function deleteMessage(index) {
            state.messages.splice(index, 1);
            localStorage.setItem('messages', JSON.stringify(state.messages));
            loadMessages();
        }

        // Clear all chat history
        function clearChatHistory() {
            if (confirm('M√∂chtest du wirklich den gesamten Chat-Verlauf l√∂schen?')) {
                state.messages = [];
                localStorage.setItem('messages', JSON.stringify([]));
                loadMessages();
                closeSettings();
            }
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function parseMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '').replace(/<p>(<h[123]>)/g, '$1').replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1').replace(/(<\/ul>)<\/p>/g, '$1');
            return html;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing');
            if (indicator) indicator.remove();
        }

        // Send message to Claude
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';
            addMessageToUI('user', message);

            if (!state.apiKey) {
                addMessageToUI('assistant', 'Bitte gib zuerst deinen Claude API Key in den Einstellungen ein (‚öôÔ∏è oben rechts).');
                return;
            }

            showTypingIndicator();

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: generateTrainingContext(),
                        messages: [
                            ...state.messages.slice(-10).map(m => ({
                                role: m.role === 'assistant' ? 'assistant' : 'user',
                                content: m.content
                            })),
                            { role: 'user', content: message }
                        ]
                    })
                });

                hideTypingIndicator();

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                addMessageToUI('assistant', data.content[0].text);
            } catch (error) {
                hideTypingIndicator();
                addMessageToUI('assistant', `Fehler: ${error.message}`);
            }
        }

        // Nutrition Date Navigation
        function changeNutritionDate(delta) {
            const current = new Date(state.currentNutritionDate);
            current.setDate(current.getDate() + delta);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Don't allow future dates
            if (current > today) return;

            state.currentNutritionDate = current.toISOString().split('T')[0];
            updateNutritionDisplay();
        }

        function goToNutritionToday() {
            state.currentNutritionDate = new Date().toISOString().split('T')[0];
            updateNutritionDisplay();
        }

        // Auto-analyze meal (like Yazio - in background)
        let mealAnalysisTimeout = null;

        function handleMealKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                triggerMealAnalysis();
            }
        }

        function handleMealBlur() {
            const input = document.getElementById('meal-input');
            if (input.value.trim()) {
                mealAnalysisTimeout = setTimeout(() => triggerMealAnalysis(), 500);
            }
        }

        async function triggerMealAnalysis() {
            clearTimeout(mealAnalysisTimeout);
            const input = document.getElementById('meal-input');
            const mealText = input.value.trim();
            if (!mealText || !state.apiKey) return;

            const indicator = document.getElementById('analyzing-indicator');
            indicator.classList.remove('hidden');

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 300,
                        system: 'Du bist ein Ern√§hrungsexperte. Analysiere die Mahlzeit und antworte NUR mit JSON: {"name": "Kurzbeschreibung max 30 Zeichen", "kcal": Zahl, "protein": Zahl, "carbs": Zahl, "fat": Zahl}. Sch√§tze realistisch basierend auf deutschen Portionsgr√∂√üen.',
                        messages: [{ role: 'user', content: mealText }]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const mealData = JSON.parse(jsonMatch[0]);
                    // Validate required fields
                    if (typeof mealData.kcal !== 'number' || typeof mealData.protein !== 'number') {
                        throw new Error('Ung√ºltige N√§hrwertdaten');
                    }
                    mealData.time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    mealData.id = Date.now();
                    mealData.original = mealText;

                    // Save to current date
                    const meals = getMealsForDate(state.currentNutritionDate);
                    meals.push(mealData);
                    saveMealsForDate(state.currentNutritionDate, meals);

                    input.value = '';
                    updateNutritionDisplay();
                    showToast(`‚úì ${mealData.name} (${mealData.kcal} kcal)`);
                    console.log('Meal saved:', mealData);
                } else {
                    throw new Error('Konnte JSON nicht parsen');
                }
            } catch (error) {
                console.error('Meal analysis error:', error);
                showToast('Fehler: ' + error.message, true);
            }

            indicator.classList.add('hidden');
        }

        // Update nutrition display
        function updateNutritionDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const isToday = state.currentNutritionDate === today;
            const displayDate = new Date(state.currentNutritionDate);

            // Update date nav
            const dateLabel = isToday ? 'Heute' : formatShortDate(displayDate) + ' ' + ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][displayDate.getDay()];
            document.getElementById('nutrition-date').textContent = dateLabel;
            document.getElementById('date-nav-next').disabled = isToday;

            // Show/hide meal input (only for today)
            document.getElementById('meal-input-card').style.display = isToday ? 'block' : 'none';
            document.getElementById('meals-title').textContent = isToday ? 'Heute gegessen' : `${formatShortDate(displayDate)} gegessen`;

            const todaysMeals = getMealsForDate(state.currentNutritionDate);

            const totals = todaysMeals.reduce((acc, meal) => ({
                kcal: acc.kcal + (meal.kcal || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0)
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

            // Activity calories from today's workouts (BOTH manual AND Strava!)
            const allTodaysActivities = [
                ...state.activities.filter(a => a.date === state.currentNutritionDate),
                ...state.stravaActivities.filter(a => a.date === state.currentNutritionDate)
            ];
            // Use Strava calories if available, otherwise estimate 10 kcal/min
            const activityKcal = allTodaysActivities.reduce((sum, a) => {
                if (a.calories) return sum + a.calories;
                return sum + ((parseInt(a.duration) || 0) * 10);
            }, 0);

            const remaining = state.calorieGoal + activityKcal - totals.kcal;

            document.getElementById('calories-remaining').textContent = Math.max(0, remaining);
            document.getElementById('calories-base').textContent = state.calorieGoal;
            document.getElementById('calories-activity').textContent = `+${activityKcal}`;
            document.getElementById('calories-food').textContent = `-${totals.kcal}`;

            const progress = Math.min(totals.kcal / (state.calorieGoal + activityKcal), 1);
            document.getElementById('calorie-progress').style.strokeDashoffset = 408 * (1 - progress);

            const proteinGoal = getProteinGoal();
            const carbsGoal = 250, fatGoal = 70;
            document.getElementById('protein-bar').style.width = `${Math.min(totals.protein / proteinGoal * 100, 100)}%`;
            document.getElementById('carbs-bar').style.width = `${Math.min(totals.carbs / carbsGoal * 100, 100)}%`;
            document.getElementById('fat-bar').style.width = `${Math.min(totals.fat / fatGoal * 100, 100)}%`;
            document.getElementById('protein-value').textContent = `${Math.round(totals.protein)}/${proteinGoal}g`;
            document.getElementById('carbs-value').textContent = `${Math.round(totals.carbs)}/${carbsGoal}g`;
            document.getElementById('fat-value').textContent = `${Math.round(totals.fat)}/${fatGoal}g`;

            const mealsContainer = document.getElementById('meals-today');
            if (todaysMeals.length === 0) {
                mealsContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Noch nichts eingetragen</div>';
            } else {
                mealsContainer.innerHTML = todaysMeals.map((meal, index) => `
                    <div class="meal-item">
                        <div class="meal-info">
                            <div class="meal-name">${meal.name}</div>
                            <div class="meal-time">${meal.time} ¬∑ P: ${meal.protein}g ¬∑ K: ${meal.carbs}g ¬∑ F: ${meal.fat}g</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="meal-kcal">${meal.kcal} kcal</div>
                            <button onclick="deleteMeal(${index})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.9rem; padding: 0.25rem;">‚úï</button>
                        </div>
                    </div>
                `).join('');
            }

            // Update weekly summary
            updateWeeklySummary();
        }

        // Delete a meal
        function deleteMeal(index) {
            const meals = getMealsForDate(state.currentNutritionDate);
            meals.splice(index, 1);
            saveMealsForDate(state.currentNutritionDate, meals);
            updateNutritionDisplay();
        }

        // Calculate weekly nutrition summary
        function updateWeeklySummary() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            let weeklyTotals = { kcal: 0, protein: 0, carbs: 0, fat: 0, days: 0 };
            let weeklyBudget = 0;
            let weeklyActivity = 0;

            // Loop through Mon-Today
            for (let i = mondayOffset; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const meals = getMealsForDate(dateStr);
                if (meals.length > 0) {
                    weeklyTotals.days++;
                    meals.forEach(m => {
                        weeklyTotals.kcal += m.kcal || 0;
                        weeklyTotals.protein += m.protein || 0;
                        weeklyTotals.carbs += m.carbs || 0;
                        weeklyTotals.fat += m.fat || 0;
                    });
                }

                // Daily budget
                weeklyBudget += state.calorieGoal;

                // Activity calories for this day
                const dayActivities = [
                    ...state.activities.filter(a => a.date === dateStr),
                    ...state.stravaActivities.filter(a => a.date === dateStr)
                ];
                dayActivities.forEach(a => {
                    if (a.calories) weeklyActivity += a.calories;
                    else weeklyActivity += ((parseInt(a.duration) || 0) * 10);
                });
            }

            const netBalance = weeklyBudget + weeklyActivity - weeklyTotals.kcal;
            const avgDailyDeficit = weeklyTotals.days > 0 ? Math.round(netBalance / (mondayOffset + 1)) : 0;

            let statusText = '';
            let statusColor = 'var(--text-secondary)';

            if (netBalance > 500) {
                statusText = `‚úÖ Du bist ${netBalance} kcal im Defizit! G√∂nn dir ruhig was.`;
                statusColor = 'var(--success)';
            } else if (netBalance > 0) {
                statusText = `üëç Leicht im Defizit (${netBalance} kcal). Gut auf Kurs!`;
                statusColor = 'var(--success)';
            } else if (netBalance > -300) {
                statusText = `‚öñÔ∏è Ungef√§hr ausgeglichen (${Math.abs(netBalance)} kcal dr√ºber)`;
                statusColor = 'var(--warning)';
            } else {
                statusText = `‚ö†Ô∏è ${Math.abs(netBalance)} kcal √ºber Budget. Morgen weniger essen!`;
                statusColor = 'var(--danger)';
            }

            const container = document.getElementById('weekly-summary-content');
            if (container) {
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <div>üçΩÔ∏è Gegessen: <strong>${weeklyTotals.kcal}</strong> kcal</div>
                        <div>üè† Budget: <strong>${weeklyBudget}</strong> kcal</div>
                        <div>üî• Aktivit√§t: <strong>+${weeklyActivity}</strong> kcal</div>
                        <div>üìä Bilanz: <strong style="color: ${statusColor}">${netBalance > 0 ? '-' : '+'}${Math.abs(netBalance)}</strong> kcal</div>
                    </div>
                    <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 8px; color: ${statusColor}; font-weight: 500;">
                        ${statusText}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">
                        √ò ${avgDailyDeficit > 0 ? 'Defizit' : '√úberschuss'}: ${Math.abs(avgDailyDeficit)} kcal/Tag | Protein: ${weeklyTotals.protein}g | ${weeklyTotals.days} Tage geloggt
                    </div>
                `;
            }
        }

        // Navigation & UI
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`screen-${screenId}`).classList.add('active');
            document.getElementById(`nav-${screenId}`).classList.add('active');

            if (screenId === 'nutrition') {
                // Reset to today when opening nutrition
                state.currentNutritionDate = new Date().toISOString().split('T')[0];
                updateNutritionDisplay();
            }
            if (screenId === 'training') updateActivitiesList();
        }

        function askCoach(question) {
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        function hideSplash() {
            document.getElementById('splash').classList.add('hidden');
            state.hasSeenSplash = true;
            localStorage.setItem('hasSeenSplash', 'true');
        }

        // Settings
        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('goal-time-input').value = state.goalTime;
            document.getElementById('race-date-input').value = state.raceDate;
            document.getElementById('user-context-input').value = state.userContext;
            document.getElementById('tone-select').value = state.tone;
            document.getElementById('calorie-goal-input').value = state.calorieGoal;
            document.getElementById('weight-input').value = state.weight;
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value;
            state.goalTime = document.getElementById('goal-time-input').value;
            state.raceDate = document.getElementById('race-date-input').value;
            state.userContext = document.getElementById('user-context-input').value;
            state.tone = document.getElementById('tone-select').value;
            state.calorieGoal = parseInt(document.getElementById('calorie-goal-input').value) || 2100;
            state.weight = parseFloat(document.getElementById('weight-input').value) || 87.5;

            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('goalTime', state.goalTime);
            localStorage.setItem('raceDate', state.raceDate);
            localStorage.setItem('userContext', state.userContext);
            localStorage.setItem('tone', state.tone);
            localStorage.setItem('calorieGoal', state.calorieGoal);
            localStorage.setItem('weight', state.weight);

            updateCountdown();
            updateNutritionDisplay();
            closeSettings();
        }

        // Strava OAuth Configuration
        const STRAVA_CONFIG = {
            clientId: '189263',
            clientSecret: '27c5a6b678e3a95d6e323bf9931244889c0183ae',
            redirectUri: 'https://fitness-coach-alpha-dun.vercel.app/',
            scope: 'activity:read_all'
        };

        // Connect to Strava (initiate OAuth)
        function connectStrava() {
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CONFIG.clientId}&redirect_uri=${encodeURIComponent(STRAVA_CONFIG.redirectUri)}&response_type=code&scope=${STRAVA_CONFIG.scope}`;
            window.location.href = authUrl;
        }

        // Handle Strava OAuth callback
        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (!code) return;

            // Clear URL params
            window.history.replaceState({}, document.title, window.location.pathname);

            // Show loading state
            const stravaBtn = document.getElementById('strava-btn');
            if (stravaBtn) stravaBtn.textContent = 'Verbinde...';

            try {
                // Exchange code for tokens
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: STRAVA_CONFIG.clientId,
                        client_secret: STRAVA_CONFIG.clientSecret,
                        code: code,
                        grant_type: 'authorization_code'
                    })
                });

                if (!response.ok) throw new Error('Token exchange failed');

                const data = await response.json();

                // Save tokens
                localStorage.setItem('stravaAccessToken', data.access_token);
                localStorage.setItem('stravaRefreshToken', data.refresh_token);
                localStorage.setItem('stravaTokenExpiry', data.expires_at);
                localStorage.setItem('stravaAthlete', JSON.stringify(data.athlete));
                localStorage.setItem('stravaConnected', 'true');

                state.stravaConnected = true;
                updateStravaUI();

                // Fetch activities
                await fetchStravaActivities();

            } catch (error) {
                console.error('Strava auth error:', error);
                alert('Strava-Verbindung fehlgeschlagen: ' + error.message);
            }
        }

        // Refresh Strava token if expired
        async function refreshStravaToken() {
            const refreshToken = localStorage.getItem('stravaRefreshToken');
            if (!refreshToken) return null;

            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: STRAVA_CONFIG.clientId,
                        client_secret: STRAVA_CONFIG.clientSecret,
                        refresh_token: refreshToken,
                        grant_type: 'refresh_token'
                    })
                });

                if (!response.ok) throw new Error('Token refresh failed');

                const data = await response.json();
                localStorage.setItem('stravaAccessToken', data.access_token);
                localStorage.setItem('stravaRefreshToken', data.refresh_token);
                localStorage.setItem('stravaTokenExpiry', data.expires_at);

                return data.access_token;
            } catch (error) {
                console.error('Token refresh error:', error);
                disconnectStrava();
                return null;
            }
        }

        // Get valid Strava access token
        async function getStravaToken() {
            const expiry = parseInt(localStorage.getItem('stravaTokenExpiry')) || 0;
            const now = Math.floor(Date.now() / 1000);

            if (now >= expiry - 60) { // Refresh if expiring within 60 seconds
                return await refreshStravaToken();
            }
            return localStorage.getItem('stravaAccessToken');
        }

        // Fetch activities from Strava
        async function fetchStravaActivities() {
            const token = await getStravaToken();
            if (!token) return;

            try {
                // Get activities from last 365 days (1 year)
                const after = Math.floor((Date.now() - 365 * 24 * 60 * 60 * 1000) / 1000);
                const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${after}&per_page=200`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch activities');

                const activities = await response.json();

                // Transform Strava activities to our format with ALL available data
                state.stravaActivities = activities.map(a => ({
                    id: `strava_${a.id}`,
                    type: mapStravaType(a.type),
                    date: a.start_date_local.split('T')[0],
                    distance: parseFloat((a.distance / 1000).toFixed(2)), // NUMBER not string!
                    duration: Math.round(a.moving_time / 60),
                    durationSeconds: a.moving_time, // Raw seconds for precise display
                    name: a.name,
                    source: 'strava',
                    averagePace: a.type === 'Run' ? formatPace(a.moving_time, a.distance) : null,
                    heartRate: a.average_heartrate || null,
                    // Additional Strava data - Use direct calories first, then kilojoules conversion, then estimate
                    calories: a.calories || (a.kilojoules ? Math.round(a.kilojoules * 0.239) : Math.round(a.moving_time / 60 * 10)),
                    elevation: a.total_elevation_gain || 0,
                    maxSpeed: a.max_speed ? (a.max_speed * 3.6).toFixed(1) : null, // m/s to km/h
                    avgSpeed: a.average_speed ? (a.average_speed * 3.6).toFixed(1) : null,
                    cadence: a.average_cadence || null,
                    sufferScore: a.suffer_score || null,
                    achievements: a.achievement_count || 0
                }));

                localStorage.setItem('stravaActivities', JSON.stringify(state.stravaActivities));

                updateActivitiesList();
                updateWeekStats();

            } catch (error) {
                console.error('Strava fetch error:', error);
            }
        }

        // Map Strava activity types to our types
        function mapStravaType(stravaType) {
            const typeMap = {
                'Run': 'run',
                'Ride': 'bike',
                'VirtualRide': 'bike',
                'Swim': 'swim',
                'WeightTraining': 'strength',
                'Workout': 'strength',
                'Yoga': 'mobility',
                'Walk': 'walk',
                'Hike': 'walk',
                'Elliptical': 'crosstrainer',
                'EBikeRide': 'bike',
                'Crossfit': 'strength',
                'StairStepper': 'crosstrainer',
                'Rowing': 'swim',
                'Tennis': 'padel',
                'Squash': 'padel',
                'Badminton': 'padel',
                'Racquetball': 'padel',
                'Basketball': 'basketball',
                'Soccer': 'basketball',
                'MountainBikeRide': 'bike',
                'GravelRide': 'bike',
                'TrailRun': 'run',
                'NordicSki': 'run',
                'RollerSki': 'run',
                'Skateboard': 'mobility',
                'Golf': 'walk',
                'Handcycle': 'bike'
            };
            return typeMap[stravaType] || 'run';
        }

        // Format pace (min/km)
        function formatPace(seconds, meters) {
            if (!meters || meters === 0) return null;
            const paceSeconds = seconds / (meters / 1000);
            const mins = Math.floor(paceSeconds / 60);
            const secs = Math.round(paceSeconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')} /km`;
        }

        // Format duration as MM:SS (e.g., 37:24)
        function formatDuration(seconds) {
            if (!seconds) return null;
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Disconnect Strava
        function disconnectStrava() {
            localStorage.removeItem('stravaAccessToken');
            localStorage.removeItem('stravaRefreshToken');
            localStorage.removeItem('stravaTokenExpiry');
            localStorage.removeItem('stravaAthlete');
            localStorage.removeItem('stravaConnected');
            state.stravaConnected = false;
            state.stravaActivities = [];
            localStorage.setItem('stravaActivities', '[]');
            updateStravaUI();
            updateActivitiesList();
            updateWeekStats();
        }

        // Update Strava UI state
        function updateStravaUI() {
            const btn = document.getElementById('strava-btn');
            const syncBtn = document.getElementById('strava-sync-btn');

            if (btn) {
                if (state.stravaConnected) {
                    const athlete = JSON.parse(localStorage.getItem('stravaAthlete') || '{}');
                    btn.innerHTML = `‚úì Verbunden${athlete.firstname ? ` als ${athlete.firstname}` : ''} <span style="font-size:0.75rem; opacity:0.8;">(Trennen)</span>`;
                    btn.onclick = () => {
                        if (confirm('Strava-Verbindung trennen?')) disconnectStrava();
                    };
                } else {
                    btn.innerHTML = 'Mit Strava verbinden';
                    btn.onclick = connectStrava;
                }
            }

            // Show/hide sync button on training page
            if (syncBtn) {
                syncBtn.style.display = state.stravaConnected ? 'flex' : 'none';
            }
        }

        // Sync Strava activities manually
        async function syncStrava() {
            const syncBtn = document.getElementById('strava-sync-btn');
            if (syncBtn) {
                syncBtn.innerHTML = '‚è≥';
                syncBtn.disabled = true;
            }

            await fetchStravaActivities();

            if (syncBtn) {
                syncBtn.innerHTML = 'üîÑ';
                syncBtn.disabled = false;
            }
        }

        // Activity Modal
        function openActivityModal() {
            document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('activity-knee').value = state.kneeStatus;
            document.getElementById('activity-modal').classList.add('active');
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('active');
        }

        function saveActivity() {
            const activity = {
                type: document.getElementById('activity-type').value,
                date: document.getElementById('activity-date').value,
                distance: parseFloat(document.getElementById('activity-distance').value) || 0,
                duration: parseInt(document.getElementById('activity-duration').value) || 0,
                kneeStatus: document.getElementById('activity-knee').value,
                notes: document.getElementById('activity-notes').value,
                id: Date.now()
            };

            state.activities.unshift(activity);
            localStorage.setItem('activities', JSON.stringify(state.activities));

            updateActivitiesList();
            updateWeekStats();
            closeActivityModal();
        }

        function updateActivitiesList() {
            const container = document.getElementById('activities-list');
            let allActivities = [...state.activities, ...state.stravaActivities]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Apply type filter
            const typeFilter = document.getElementById('filter-type')?.value || 'all';
            if (typeFilter !== 'all') {
                allActivities = allActivities.filter(a => a.type === typeFilter);
            }

            // Apply period filter
            const periodFilter = document.getElementById('filter-period')?.value || 'all';
            const now = new Date();
            if (periodFilter !== 'all') {
                let startDate;
                switch(periodFilter) {
                    case 'week':
                        startDate = new Date(now);
                        const dow = now.getDay();
                        startDate.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1));
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case '3months':
                        startDate = new Date(now);
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                    case '6months':
                        startDate = new Date(now);
                        startDate.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                }
                if (startDate) {
                    startDate.setHours(0,0,0,0);
                    allActivities = allActivities.filter(a => new Date(a.date) >= startDate);
                }
            }

            if (allActivities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>Keine Aktivit√§ten gefunden</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">${state.stravaConnected ? '√Ñndere den Filter oder synchronisiere Strava' : 'Verbinde Strava oder f√ºge manuell hinzu'}</p>
                        ${!state.stravaConnected ? `<button class="strava-connect" onclick="connectStrava()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                            Mit Strava verbinden
                        </button>` : ''}
                    </div>`;
                return;
            }

            const typeIcons = { run: 'üèÉ', bike: 'üö¥', swim: 'üèä', strength: 'üí™', mobility: 'üßò', walk: 'üö∂', crosstrainer: 'üèãÔ∏è', padel: 'üéæ', basketball: 'üèÄ' };
            const typeNames = { run: 'Lauf', bike: 'Radfahren', swim: 'Schwimmen', strength: 'Krafttraining', mobility: 'Mobility', walk: 'Gehen', crosstrainer: 'Crosstrainer', padel: 'Padel', basketball: 'Basketball' };
            const kneeIcons = { green: 'üü¢', yellow: 'üü°', red: 'üî¥' };
            const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

            // Group by month
            const grouped = {};
            allActivities.forEach(a => {
                const d = new Date(a.date);
                const key = `${d.getFullYear()}-${d.getMonth()}`;
                if (!grouped[key]) {
                    grouped[key] = { label: `${monthNames[d.getMonth()]} ${d.getFullYear()}`, activities: [] };
                }
                grouped[key].activities.push(a);
            });

            // Render grouped
            let html = '';
            Object.values(grouped).forEach(group => {
                html += `<div style="font-weight: 600; color: var(--accent); margin: 1rem 0 0.5rem; font-size: 0.9rem;">${group.label}</div>`;
                group.activities.forEach(a => {
                    html += `
                        <div class="activity-card">
                            <div class="activity-header">
                                <div class="activity-type">
                                    <span class="activity-icon">${typeIcons[a.type] || 'üèÉ'}</span>
                                    <span class="activity-name">${a.name || typeNames[a.type] || a.type}</span>
                                    ${a.kneeStatus ? `<span>${kneeIcons[a.kneeStatus] || ''}</span>` : ''}
                                </div>
                                <div class="activity-date">${new Date(a.date).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric' })}</div>
                            </div>
                            <div class="activity-stats" style="flex-wrap: wrap;">
                                ${a.distance ? `<span class="activity-stat">üìè ${parseFloat(a.distance).toFixed(1)} km</span>` : ''}
                                ${a.durationSeconds ? `<span class="activity-stat">‚è±Ô∏è ${formatDuration(a.durationSeconds)}</span>` : (a.duration ? `<span class="activity-stat">‚è±Ô∏è ${a.duration} min</span>` : '')}
                                ${a.averagePace ? `<span class="activity-stat">üèÉ ${a.averagePace}</span>` : ''}
                                ${a.heartRate ? `<span class="activity-stat">‚ù§Ô∏è ${Math.round(a.heartRate)} bpm</span>` : ''}
                                ${a.elevation ? `<span class="activity-stat">‚õ∞Ô∏è ${Math.round(a.elevation)}m</span>` : ''}
                                ${a.calories ? `<span class="activity-stat">üî• ${a.calories} kcal</span>` : ''}
                                ${a.cadence ? `<span class="activity-stat">üëü ${Math.round(a.cadence)} spm</span>` : ''}
                                ${a.source === 'strava' ? '<span class="activity-stat" style="color: #fc4c02; font-size: 0.75rem;">Strava</span>' : ''}
                            </div>
                        </div>`;
                });
            });

            container.innerHTML = html;
        }

        function updateWeekStats() {
            const today = new Date();
            const weekStart = new Date(today);
            // Start from Monday (getDay() returns 0 for Sunday)
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0
            weekStart.setDate(today.getDate() - diff);
            weekStart.setHours(0, 0, 0, 0);

            const allActivities = [...state.activities, ...state.stravaActivities];

            // Filter activities from this week (all types, not just runs)
            const weekActivities = allActivities.filter(a => new Date(a.date) >= weekStart);

            // Calculate km (parse as float to handle string values, with NaN protection)
            const weekKmRaw = weekActivities
                .filter(a => a.type === 'run')
                .reduce((sum, a) => {
                    const dist = parseFloat(a.distance);
                    return sum + (isNaN(dist) ? 0 : dist);
                }, 0);
            const weekKm = isNaN(weekKmRaw) ? 0 : weekKmRaw;

            // Calculate total activity minutes this week (all types)
            const weekMinutes = weekActivities.reduce((sum, a) => {
                const dur = parseInt(a.duration);
                return sum + (isNaN(dur) ? 0 : dur);
            }, 0);

            document.getElementById('week-km').innerHTML = `${(Number(weekKm) || 0).toFixed(1)} <span class="stat-unit">km</span>`;
            document.getElementById('week-trend').textContent = `${weekMinutes} min Aktivit√§t`;

            // Show activity minutes in second card instead of 4-week average
            document.getElementById('month-km').innerHTML = `${weekMinutes} <span class="stat-unit">min</span>`;
            document.getElementById('month-trend').textContent = 'Aktivit√§t diese Woche';
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW:', err));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (state.hasSeenSplash) document.getElementById('splash').classList.add('hidden');
            updateCountdown();
            updateKneeDisplay();
            loadMessages();
            updateActivitiesList();
            updateWeekStats();
            updateNutritionDisplay();
            updateStravaUI();

            // Check for Strava OAuth callback
            await handleStravaCallback();

            // Auto-refresh Strava activities if connected
            if (state.stravaConnected) {
                fetchStravaActivities();
            }

            const input = document.getElementById('chat-input');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            });
        });
    </script>
    <div class="toast" id="toast"></div>
</body>
</html>
