<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Road to Madrid">
    <meta name="theme-color" content="#1a202c">
    <title>Road to Madrid</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --accent: #ed8936;
            --accent-light: #fbd38d;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #fc8181;
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
        }
        html { height: -webkit-fill-available; }
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* Splash Screen */
        .splash {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .splash.hidden { opacity: 0; visibility: hidden; }
        .splash-logo { font-size: 4rem; margin-bottom: 1rem; }
        .splash-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .splash-subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .splash-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
        }
        .header-title { font-size: 1.25rem; font-weight: 600; }
        .header-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            padding: 0.5rem;
            gap: 0.25rem;
            flex-shrink: 0; /* WICHTIG: Nav darf nicht schrumpfen! */
            position: relative;
            z-index: 100;
        }
        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        .nav-btn.active { background: var(--bg-tertiary); color: var(--accent); }
        .nav-btn svg { width: 24px; height: 24px; }

        /* Screens */
        .screen { display: none; flex: 1; overflow: hidden; }
        .screen.active { display: flex; flex-direction: column; }

        /* Chat Screen */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        .message-container.user { align-self: flex-end; }
        .message-container.assistant { align-self: flex-start; }
        .message {
            padding: 0.875rem 1rem;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 0.95rem;
            position: relative;
        }
        .message.user {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            background: var(--bg-secondary);
            border-bottom-left-radius: 4px;
        }
        .message.assistant h1, .message.assistant h2, .message.assistant h3 { margin: 0.5rem 0; color: var(--accent); }
        .message.assistant h1 { font-size: 1.2rem; }
        .message.assistant h2 { font-size: 1.1rem; }
        .message.assistant h3 { font-size: 1rem; }
        .message.assistant ul, .message.assistant ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .message.assistant li { margin: 0.25rem 0; }
        .message.assistant strong { color: var(--accent-light); }
        .message.assistant code { background: var(--bg-tertiary); padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.85em; }
        .message.assistant pre { background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; overflow-x: auto; margin: 0.5rem 0; }
        .message.assistant pre code { background: none; padding: 0; }
        .message.assistant p { margin: 0.5rem 0; }
        .message.assistant p:first-child { margin-top: 0; }
        .message.assistant p:last-child { margin-bottom: 0; }

        .message-delete {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            opacity: 0.5;
            transition: opacity 0.2s;
            align-self: flex-end;
            margin-top: 0.25rem;
        }
        .message-delete:hover { opacity: 1; color: var(--danger); }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
            align-self: flex-start;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input-container {
            padding: 1rem;
            background: var(--bg-secondary);
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 20px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
        }
        .chat-input::placeholder { color: var(--text-secondary); }
        .send-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .send-btn svg { fill: white; width: 20px; height: 20px; }

        /* Multi-Chat Header */
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .chat-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            background: var(--bg-tertiary);
            flex: 1;
            max-width: 250px;
        }
        .chat-selector:hover { background: var(--bg-primary); }
        .chat-selector-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }
        .chat-selector-icon { color: var(--text-secondary); font-size: 0.8rem; }
        .new-chat-btn {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .new-chat-btn:hover { background: #dd6b20; }

        /* Chat List Modal */
        .chat-list-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .chat-list-modal.hidden { display: none; }
        .chat-list-container {
            background: var(--bg-secondary);
            border-radius: 16px 16px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-list-header h3 { font-size: 1rem; }
        .chat-list-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .chat-list {
            overflow-y: auto;
            flex: 1;
        }
        .chat-list-item {
            padding: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-list-item:hover { background: var(--bg-tertiary); }
        .chat-list-item.active { background: var(--bg-primary); border-left: 3px solid var(--accent); }
        .chat-list-item-info { flex: 1; min-width: 0; }
        .chat-list-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-list-item-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0.25rem;
        }
        .chat-list-item-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
            white-space: nowrap;
        }
        .chat-delete-btn {
            background: none;
            border: none;
            color: var(--danger);
            padding: 0.5rem;
            cursor: pointer;
            opacity: 0.6;
        }
        .chat-delete-btn:hover { opacity: 1; }

        /* Portion Selection Modal */
        .portion-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .portion-modal.hidden { display: none; }
        .portion-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .portion-header {
            padding: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .portion-product-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        .portion-base-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .portion-options {
            padding: 1rem;
            overflow-y: auto;
        }
        .portion-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            background: var(--bg-tertiary);
        }
        .portion-option:hover { background: var(--bg-primary); }
        .portion-option.selected {
            background: var(--accent);
            color: white;
        }
        .portion-option-icon { font-size: 1.5rem; margin-right: 0.75rem; }
        .portion-option-info { flex: 1; }
        .portion-option-name { font-weight: 500; }
        .portion-option-amount { font-size: 0.8rem; opacity: 0.8; }
        .portion-custom {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bg-tertiary);
        }
        .portion-custom-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .portion-custom-input {
            display: flex;
            gap: 0.5rem;
        }
        .portion-custom-input input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }
        .portion-custom-input input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .portion-preview {
            padding: 1rem;
            background: var(--bg-primary);
            border-top: 1px solid var(--bg-tertiary);
        }
        .portion-preview-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .portion-preview-macros {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .portion-macro { }
        .portion-macro-value { font-size: 1.25rem; font-weight: 600; }
        .portion-macro-label { font-size: 0.7rem; color: var(--text-secondary); }
        .portion-macro.kcal .portion-macro-value { color: var(--accent); }
        .portion-actions {
            padding: 1rem;
            display: flex;
            gap: 0.75rem;
        }
        .portion-btn {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }
        .portion-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .portion-btn-add {
            background: var(--accent);
            color: white;
        }

        /* Dashboard */
        .dashboard { padding: 1rem; overflow-y: auto; }
        .countdown-card {
            background: linear-gradient(135deg, var(--accent) 0%, #dd6b20 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .countdown-label { font-size: 0.875rem; opacity: 0.9; }
        .countdown-value { font-size: 3rem; font-weight: 700; }
        .countdown-event { font-size: 1rem; opacity: 0.9; }
        .countdown-date { font-size: 0.8rem; opacity: 0.7; margin-top: 0.25rem; }

        /* Readiness Score Card */
        .readiness-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .readiness-score-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .readiness-score-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1;
        }
        .readiness-score-label {
            font-size: 0.6rem;
            opacity: 0.8;
        }
        .readiness-info {
            flex: 1;
            min-width: 0;
        }
        .readiness-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        .readiness-limit {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .readiness-warnings {
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }
        .readiness-warning {
            background: rgba(252, 129, 129, 0.2);
            color: #fc8181;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-top: 0.25rem;
            display: inline-block;
        }

        /* Garmin Data Card */
        .garmin-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .garmin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .garmin-title {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .garmin-sync-btn {
            background: #11a9ed;
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .garmin-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        .garmin-metric {
            text-align: center;
            padding: 0.5rem 0.25rem;
            background: var(--bg-primary);
            border-radius: 8px;
        }
        .garmin-metric-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .garmin-metric-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        .garmin-not-connected {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .quick-action {
            background: var(--bg-secondary);
            border: none;
            border-radius: 12px;
            padding: 1rem 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .quick-action svg { width: 24px; height: 24px; stroke: var(--accent); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .stat-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-value { font-size: 1.5rem; font-weight: 600; }
        .stat-unit { font-size: 0.875rem; color: var(--text-secondary); }
        .stat-trend { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-trend.up { color: var(--success); }

        .knee-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .knee-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .knee-title { font-weight: 600; }
        .knee-status { display: flex; gap: 0.5rem; }
        .knee-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .knee-dot.green { background: var(--success); }
        .knee-dot.yellow { background: var(--warning); }
        .knee-dot.red { background: var(--danger); }
        .knee-dot.active { border-color: white; transform: scale(1.15); }
        .knee-info { font-size: 0.875rem; color: var(--text-secondary); }

        /* Training Screen */
        .training-list { flex: 1; overflow-y: auto; padding: 1rem; }
        .training-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .training-title { font-size: 1.25rem; font-weight: 600; }
        .add-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
        }
        .activity-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; }
        .activity-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .activity-type { display: flex; align-items: center; gap: 0.5rem; }
        .activity-icon { font-size: 1.25rem; }
        .activity-name { font-weight: 600; }
        .activity-date { font-size: 0.75rem; color: var(--text-secondary); }
        .activity-stats { display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-secondary); }
        .activity-stat { display: flex; align-items: center; gap: 0.25rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

        /* Strava Connect */
        .strava-connect {
            background: #fc4c02;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Nutrition Screen */
        .nutrition-screen { flex: 1; overflow-y: auto; padding: 1rem; }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 0.75rem;
        }
        .date-nav-btn {
            background: var(--bg-tertiary);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .date-nav-current { font-weight: 600; min-width: 140px; text-align: center; }
        .date-nav-today {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .calorie-card {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .calorie-ring { width: 150px; height: 150px; margin: 0 auto 1rem; position: relative; }
        .calorie-ring svg { transform: rotate(-90deg); }
        .calorie-ring-bg { fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 12; }
        .calorie-ring-progress { fill: none; stroke: white; stroke-width: 12; stroke-linecap: round; stroke-dasharray: 408; stroke-dashoffset: 408; transition: stroke-dashoffset 0.5s; }
        .calorie-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .calorie-remaining { font-size: 2rem; font-weight: 700; }
        .calorie-label { font-size: 0.75rem; opacity: 0.8; }
        .calorie-breakdown { display: flex; justify-content: space-around; margin-top: 1rem; }
        .calorie-item { text-align: center; }
        .calorie-item-value { font-size: 1.25rem; font-weight: 600; }
        .calorie-item-label { font-size: 0.7rem; opacity: 0.8; }

        .macros-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .macros-title { font-weight: 600; margin-bottom: 0.75rem; }
        .macro-row { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .macro-label { width: 80px; font-size: 0.875rem; }
        .macro-bar { flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin: 0 0.75rem; }
        .macro-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .macro-bar-fill.protein { background: #ed8936; }
        .macro-bar-fill.carbs { background: #4299e1; }
        .macro-bar-fill.fat { background: #9f7aea; }
        .macro-value { font-size: 0.875rem; width: 70px; text-align: right; }

        .meal-input-card { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .meal-input-title { font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .meal-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 60px;
        }
        .meal-textarea::placeholder { color: var(--text-secondary); }
        .meal-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .analyzing-indicator { display: flex; align-items: center; gap: 0.5rem; color: var(--accent); font-size: 0.875rem; margin-top: 0.5rem; }
        .analyzing-indicator.hidden { display: none; }

        .meals-list { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .meals-title { font-weight: 600; margin-bottom: 0.75rem; }
        .meal-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--bg-tertiary); }
        .meal-item:last-child { border-bottom: none; }
        .meal-info { flex: 1; }
        .meal-name { font-size: 0.9rem; }
        .meal-time { font-size: 0.75rem; color: var(--text-secondary); }
        .meal-kcal { font-weight: 600; color: var(--accent); }

        /* Product Search */
        .search-container { position: relative; }
        .search-input-row { display: flex; gap: 0.5rem; }
        .search-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .search-input::placeholder { color: var(--text-secondary); }
        .barcode-btn {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: 0 0 12px 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .search-results.hidden { display: none; }
        .search-result-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item:hover { background: var(--bg-tertiary); }
        .search-result-item:last-child { border-bottom: none; border-radius: 0 0 12px 12px; }
        .result-name { font-size: 0.9rem; margin-bottom: 0.25rem; }
        .result-brand { font-size: 0.75rem; color: var(--text-secondary); }
        .result-macros { font-size: 0.75rem; color: var(--accent); margin-top: 0.25rem; }
        .search-loading, .search-empty { padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.85rem; }
        .ai-fallback { padding: 0.75rem 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-top: 0.5rem; cursor: pointer; font-size: 0.85rem; }
        .ai-fallback:hover { background: var(--accent); color: white; }

        /* Barcode Scanner Modal */
        .scanner-modal {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        .scanner-modal.hidden { display: none; }
        .scanner-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }
        .scanner-video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .scanner-video {
            width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .scanner-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scanner-frame {
            width: 250px;
            height: 150px;
            border: 2px solid var(--accent);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .scanner-hint {
            position: absolute;
            bottom: 2rem;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 0.9rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }
        .modal-header h2 { font-size: 1.125rem; }
        .modal-close { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        .modal-content { padding: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-input { width: 100%; background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; }
        .form-textarea { width: 100%; background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 0.9rem; resize: vertical; min-height: 100px; font-family: inherit; }
        .form-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .form-section { margin-bottom: 1.5rem; }
        .form-section-title { font-weight: 600; margin-bottom: 0.75rem; color: var(--accent); }
        .btn { width: 100%; padding: 0.875rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; margin-bottom: 0.5rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-size: 0.9rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            border-left: 3px solid var(--success);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.error {
            border-left-color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Splash Screen -->
        <div class="splash" id="splash">
            <div class="splash-logo">üèÉ‚Äç‚ôÇÔ∏è</div>
            <div class="splash-title">Road to Madrid</div>
            <div class="splash-subtitle">Halbmarathon ¬∑ 22. M√§rz 2026</div>
            <button class="splash-btn" onclick="hideSplash()">Los geht's</button>
        </div>

        <!-- Header -->
        <header class="header">
            <h1 class="header-title">Road to Madrid</h1>
            <button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </header>

        <!-- Chat Screen -->
        <div class="screen active" id="screen-chat">
            <div class="chat-header">
                <div class="chat-selector" onclick="openChatList()">
                    <span class="chat-selector-title" id="current-chat-title">Neuer Chat</span>
                    <span class="chat-selector-icon">‚ñº</span>
                </div>
                <button class="new-chat-btn" onclick="createNewChat()">
                    <span>+</span> Neu
                </button>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chat-input" placeholder="Nachricht eingeben..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

        <!-- Chat List Modal -->
        <div class="chat-list-modal hidden" id="chat-list-modal" onclick="closeChatList(event)">
            <div class="chat-list-container" onclick="event.stopPropagation()">
                <div class="chat-list-header">
                    <h3>Deine Chats</h3>
                    <button class="chat-list-close" onclick="closeChatList()">&times;</button>
                </div>
                <div class="chat-list" id="chat-list"></div>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="screen-dashboard">
            <div class="dashboard">
                <div class="countdown-card">
                    <div class="countdown-label">Tage bis Madrid</div>
                    <div class="countdown-value" id="countdown-days">48</div>
                    <div class="countdown-event">üá™üá∏ Halbmarathon Madrid</div>
                    <div class="countdown-date" id="countdown-date">22. M√§rz 2026</div>
                </div>

                <!-- Readiness Score -->
                <div class="readiness-card" id="readiness-card">
                    <div class="readiness-score-circle" id="readiness-circle" style="background: #48bb78;">
                        <div class="readiness-score-value" id="readiness-value">10</div>
                        <div class="readiness-score-label">READY</div>
                    </div>
                    <div class="readiness-info">
                        <div class="readiness-title" id="readiness-title">Volle Kapazit√§t</div>
                        <div class="readiness-limit" id="readiness-limit">Intensit√§t nach Plan m√∂glich</div>
                        <div class="readiness-warnings" id="readiness-warnings"></div>
                    </div>
                </div>

                <!-- Garmin Data -->
                <div class="garmin-card" id="garmin-card">
                    <div class="garmin-header">
                        <div class="garmin-title">‚åö Garmin Daten</div>
                        <button class="garmin-sync-btn" onclick="syncGarmin()" id="garmin-sync-btn" style="display: none;">üîÑ Sync</button>
                    </div>
                    <div id="garmin-content">
                        <div class="garmin-not-connected">
                            Verbinde Garmin in den Einstellungen<br>
                            <small style="opacity: 0.7;">f√ºr Schlaf, HRV, Body Battery & mehr</small>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Was steht heute auf meinem Trainingsplan?')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Tagesplan
                    </button>
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Erstelle mir einen angepassten Wochenplan!')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Wochenplan
                    </button>
                    <button class="quick-action" onclick="showScreen('chat'); askCoach('Analysiere meine letzten Trainings und gib mir Feedback!')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        Analyse
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">üèÉ Lauf-km diese Woche</div>
                        <div class="stat-value" id="week-km">0 <span class="stat-unit">km</span></div>
                        <div class="stat-trend" id="week-trend">aus Strava</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚è±Ô∏è Aktivit√§t diese Woche</div>
                        <div class="stat-value" id="month-km">0 <span class="stat-unit">min</span></div>
                        <div class="stat-trend" id="month-trend">alle Sportarten</div>
                    </div>
                </div>

                <div class="knee-card">
                    <div class="knee-header">
                        <div class="knee-title">ü¶µ Knie-Status heute</div>
                        <div class="knee-status">
                            <div class="knee-dot green" onclick="setKneeStatus('green')"></div>
                            <div class="knee-dot yellow" onclick="setKneeStatus('yellow')"></div>
                            <div class="knee-dot red" onclick="setKneeStatus('red')"></div>
                        </div>
                    </div>
                    <div class="knee-info" id="knee-info">Tippe auf eine Farbe um deinen Status zu aktualisieren</div>
                </div>
            </div>
        </div>

        <!-- Training Screen -->
        <div class="screen" id="screen-training">
            <div class="training-list">
                <div class="training-header">
                    <h2 class="training-title">Aktivit√§ten</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="add-btn" onclick="syncStrava()" id="strava-sync-btn" style="background: #fc4c02; font-size: 1rem; display: none;">üîÑ</button>
                        <button class="add-btn" onclick="openActivityModal()">+</button>
                    </div>
                </div>

                <!-- Activity Filters -->
                <div class="activity-filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    <select id="filter-type" onchange="updateActivitiesList()" style="background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.8rem;">
                        <option value="all">Alle Typen</option>
                        <option value="run">Lauf</option>
                        <option value="bike">Radfahren</option>
                        <option value="swim">Schwimmen</option>
                        <option value="strength">Krafttraining</option>
                        <option value="mobility">Mobility</option>
                        <option value="walk">Gehen</option>
                        <option value="crosstrainer">Crosstrainer</option>
                        <option value="padel">Padel</option>
                        <option value="basketball">Basketball</option>
                    </select>
                    <select id="filter-period" onchange="updateActivitiesList()" style="background: var(--bg-tertiary); border: none; border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.8rem;">
                        <option value="all">Alle Zeit</option>
                        <option value="week">Diese Woche</option>
                        <option value="month">Diesen Monat</option>
                        <option value="3months">Letzte 3 Monate</option>
                        <option value="6months">Letzte 6 Monate</option>
                        <option value="year">Dieses Jahr</option>
                    </select>
                </div>

                <div id="activities-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>Noch keine Aktivit√§ten</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Verbinde Strava um deine L√§ufe zu importieren</p>
                        <button class="strava-connect" onclick="connectStrava()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                            Mit Strava verbinden
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutrition Screen -->
        <div class="screen" id="screen-nutrition">
            <div class="nutrition-screen">
                <!-- Date Navigation -->
                <div class="date-nav">
                    <button class="date-nav-btn" onclick="changeNutritionDate(-1)">‚Äπ</button>
                    <div class="date-nav-current" id="nutrition-date">Heute</div>
                    <button class="date-nav-btn" onclick="changeNutritionDate(1)" id="date-nav-next">‚Ä∫</button>
                    <button class="date-nav-today" onclick="goToNutritionToday()">Heute</button>
                </div>

                <div class="calorie-card">
                    <div class="calorie-ring">
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <circle class="calorie-ring-bg" cx="75" cy="75" r="65"/>
                            <circle class="calorie-ring-progress" id="calorie-progress" cx="75" cy="75" r="65"/>
                        </svg>
                        <div class="calorie-center">
                            <div class="calorie-remaining" id="calories-remaining">2100</div>
                            <div class="calorie-label">√ºbrig</div>
                        </div>
                    </div>
                    <div class="calorie-breakdown">
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-base">2100</div>
                            <div class="calorie-item-label">Grundumsatz</div>
                        </div>
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-activity">+0</div>
                            <div class="calorie-item-label">Aktivit√§t</div>
                        </div>
                        <div class="calorie-item">
                            <div class="calorie-item-value" id="calories-food">-0</div>
                            <div class="calorie-item-label">Gegessen</div>
                        </div>
                    </div>
                </div>

                <div class="macros-card">
                    <div class="macros-title">Makros</div>
                    <div class="macro-row">
                        <span class="macro-label">Protein</span>
                        <div class="macro-bar"><div class="macro-bar-fill protein" id="protein-bar" style="width: 0%"></div></div>
                        <span class="macro-value" id="protein-value">0/175g</span>
                    </div>
                    <div class="macro-row">
                        <span class="macro-label">Kohlenhydr.</span>
                        <div class="macro-bar"><div class="macro-bar-fill carbs" id="carbs-bar" style="width: 0%"></div></div>
                        <span class="macro-value" id="carbs-value">0/250g</span>
                    </div>
                    <div class="macro-row">
                        <span class="macro-label">Fett</span>
                        <div class="macro-bar"><div class="macro-bar-fill fat" id="fat-bar" style="width: 0%"></div></div>
                        <span class="macro-value" id="fat-value">0/70g</span>
                    </div>
                </div>

                <div class="meal-input-card" id="meal-input-card">
                    <div class="meal-input-title">üçΩÔ∏è Was hast du gegessen?</div>
                    <div class="search-container">
                        <div class="search-input-row">
                            <input type="text" class="search-input" id="food-search" placeholder="Produkt suchen (z.B. Ehrmann Protein)" oninput="searchFood()" onkeydown="handleFoodSearchKeydown(event)">
                            <button class="barcode-btn" onclick="openBarcodeScanner()" title="Barcode scannen">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><line x1="7" y1="12" x2="7" y2="12"></line><line x1="12" y1="12" x2="12" y2="12"></line><line x1="17" y1="12" x2="17" y2="12"></line></svg>
                            </button>
                        </div>
                        <div class="search-results hidden" id="search-results"></div>
                    </div>
                    <div class="meal-hint">Suche ein Produkt oder scanne den Barcode ¬∑ <span style="color: var(--accent); cursor: pointer;" onclick="toggleAiInput()">Oder per KI sch√§tzen</span></div>

                    <!-- AI Fallback Input (hidden by default) -->
                    <div id="ai-input-section" class="hidden" style="margin-top: 0.75rem;">
                        <textarea class="meal-textarea" id="meal-input" placeholder="Freier Text: 2 Eier, Toast, Kaffee mit Milch" onkeydown="handleMealKeyDown(event)"></textarea>
                        <button class="btn btn-primary" onclick="triggerMealAnalysis()" style="margin-top: 0.5rem;">KI analysieren</button>
                    </div>

                    <div class="analyzing-indicator hidden" id="analyzing-indicator">
                        <span class="typing-indicator" style="padding: 0;"><span></span><span></span><span></span></span>
                        Analysiere...
                    </div>
                </div>

                <!-- Barcode Scanner Modal -->
                <div class="scanner-modal hidden" id="scanner-modal">
                    <div class="scanner-header">
                        <span style="font-weight: 600;">Barcode scannen</span>
                        <button onclick="closeBarcodeScanner()" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">‚úï</button>
                    </div>
                    <div class="scanner-video-container">
                        <video id="scanner-video" class="scanner-video" autoplay playsinline></video>
                        <div class="scanner-overlay">
                            <div class="scanner-frame"></div>
                        </div>
                        <div class="scanner-hint">Barcode im Rahmen positionieren</div>
                    </div>
                </div>

                <div class="meals-list">
                    <div class="meals-title" id="meals-title">Heute gegessen</div>
                    <div id="meals-today">
                        <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Noch nichts eingetragen</div>
                    </div>
                </div>

                <!-- Weekly Summary -->
                <div class="macros-card" id="weekly-summary" style="margin-top: 1rem;">
                    <div class="macros-title">üìä Wochenbilanz (Mo-So)</div>
                    <div id="weekly-summary-content" style="font-size: 0.85rem; color: var(--text-secondary);">
                        Lade...
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" onclick="showScreen('chat')" id="nav-chat">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                Chat
            </button>
            <button class="nav-btn" onclick="showScreen('dashboard')" id="nav-dashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Dashboard
            </button>
            <button class="nav-btn" onclick="showScreen('training')" id="nav-training">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                Training
            </button>
            <button class="nav-btn" onclick="showScreen('nutrition')" id="nav-nutrition">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                Ern√§hrung
            </button>
        </nav>
    </div>

    <!-- Portion Selection Modal -->
    <div class="portion-modal hidden" id="portion-modal">
        <div class="portion-container">
            <div class="portion-header">
                <div class="portion-product-name" id="portion-product-name">Produkt</div>
                <div class="portion-base-info" id="portion-base-info">pro 100g</div>
            </div>
            <div class="portion-options" id="portion-options">
                <!-- Filled by JS -->
            </div>
            <div class="portion-preview">
                <div class="portion-preview-title">N√§hrwerte f√ºr gew√§hlte Portion:</div>
                <div class="portion-preview-macros">
                    <div class="portion-macro kcal">
                        <div class="portion-macro-value" id="portion-kcal">0</div>
                        <div class="portion-macro-label">kcal</div>
                    </div>
                    <div class="portion-macro">
                        <div class="portion-macro-value" id="portion-protein">0g</div>
                        <div class="portion-macro-label">Protein</div>
                    </div>
                    <div class="portion-macro">
                        <div class="portion-macro-value" id="portion-carbs">0g</div>
                        <div class="portion-macro-label">Carbs</div>
                    </div>
                    <div class="portion-macro">
                        <div class="portion-macro-value" id="portion-fat">0g</div>
                        <div class="portion-macro-label">Fett</div>
                    </div>
                </div>
            </div>
            <div class="portion-actions">
                <button class="portion-btn portion-btn-cancel" onclick="closePortionModal()">Abbrechen</button>
                <button class="portion-btn portion-btn-add" onclick="confirmPortion()">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Einstellungen</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-content">
                <div class="form-section">
                    <div class="form-section-title">üîë API & Verbindungen</div>
                    <div class="form-group">
                        <label class="form-label">Claude API Key</label>
                        <input type="password" class="form-input" id="api-key-input" placeholder="sk-ant-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Strava</label>
                        <button class="strava-connect" onclick="connectStrava()" id="strava-btn" style="width: 100%;">
                            Mit Strava verbinden
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Garmin Connect</label>
                        <div id="garmin-status" style="margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">Nicht verbunden</div>
                        <input type="email" class="form-input" id="garmin-email" placeholder="Garmin Email" style="margin-bottom: 0.5rem;">
                        <input type="password" class="form-input" id="garmin-password" placeholder="Garmin Passwort" style="margin-bottom: 0.5rem;">
                        <button class="strava-connect" onclick="connectGarmin()" id="garmin-btn" style="width: 100%; background: #11a9ed;">
                            ‚åö Mit Garmin verbinden
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üéØ Ziel</div>
                    <div class="form-group">
                        <label class="form-label">Zielzeit Halbmarathon</label>
                        <input type="text" class="form-input" id="goal-time-input" placeholder="1:59:59" value="1:59:59">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Renndatum</label>
                        <input type="date" class="form-input" id="race-date-input" value="2026-03-22">
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ü§ñ Coach-Pers√∂nlichkeit</div>
                    <div class="form-group">
                        <label class="form-label">Zus√§tzliche Infos √ºber dich</label>
                        <textarea class="form-textarea" id="user-context-input" placeholder="z.B.: Ich arbeite im B√ºro, stehe um 6 Uhr auf, trainiere am liebsten abends..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tonalit√§t</label>
                        <select class="form-input" id="tone-select">
                            <option value="motivierend">Motivierend & Positiv</option>
                            <option value="sachlich">Sachlich & Direkt</option>
                            <option value="freundlich">Freundlich & Locker</option>
                            <option value="streng">Streng & Fordernd</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">üçé Ern√§hrung</div>
                    <div class="form-group">
                        <label class="form-label">T√§glicher Kalorienbedarf (kcal)</label>
                        <input type="number" class="form-input" id="calorie-goal-input" value="2100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">K√∂rpergewicht (kg) - f√ºr Proteinberechnung</label>
                        <input type="number" class="form-input" id="weight-input" value="87.5">
                        <div class="form-hint">Protein-Ziel: 2g pro kg K√∂rpergewicht</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
                <button class="btn btn-danger" onclick="clearChatHistory()">Chat-Verlauf l√∂schen</button>
                <button class="btn btn-secondary" onclick="closeSettings()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Aktivit√§t hinzuf√ºgen</h2>
                <button class="modal-close" onclick="closeActivityModal()">√ó</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Aktivit√§tstyp</label>
                    <select class="form-input" id="activity-type">
                        <option value="run">üèÉ Lauf</option>
                        <option value="walk">üö∂ Gehen</option>
                        <option value="bike">üö¥ Radfahren</option>
                        <option value="swim">üèä Schwimmen</option>
                        <option value="strength">üí™ Krafttraining</option>
                        <option value="crosstrainer">üèãÔ∏è Crosstrainer</option>
                        <option value="mobility">üßò Mobility/Yoga</option>
                        <option value="padel">üéæ Padel/Tennis</option>
                        <option value="basketball">üèÄ Basketball/Fu√üball</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" class="form-input" id="activity-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Distanz (km)</label>
                    <input type="number" step="0.1" class="form-input" id="activity-distance" placeholder="z.B. 5.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Dauer (Minuten)</label>
                    <input type="number" class="form-input" id="activity-duration" placeholder="z.B. 30">
                </div>
                <div class="form-group">
                    <label class="form-label">Wie hat sich dein Knie angef√ºhlt?</label>
                    <select class="form-input" id="activity-knee">
                        <option value="green">üü¢ Alles OK</option>
                        <option value="yellow">üü° Leichte Beschwerden</option>
                        <option value="red">üî¥ Schmerzen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-textarea" id="activity-notes" placeholder="Wie hast du dich gef√ºhlt?"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveActivity()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // Generate unique chat ID
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize multi-chat system with migration from old single-chat
        function initializeChats() {
            const storedChats = localStorage.getItem('chats');
            const oldMessages = localStorage.getItem('messages');

            if (storedChats) {
                return JSON.parse(storedChats);
            }

            // Migrate from old single messages array
            if (oldMessages) {
                const messages = JSON.parse(oldMessages);
                if (messages.length > 0) {
                    const chatId = generateChatId();
                    return {
                        [chatId]: {
                            id: chatId,
                            title: 'Migrierter Chat',
                            messages: messages,
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        }
                    };
                }
            }

            // Create default empty chat
            const chatId = generateChatId();
            return {
                [chatId]: {
                    id: chatId,
                    title: 'Neuer Chat',
                    messages: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                }
            };
        }

        function getFirstChatId(chats) {
            const sorted = Object.values(chats).sort((a, b) => b.updatedAt - a.updatedAt);
            return sorted[0]?.id || null;
        }

        // State
        const chatsData = initializeChats();
        const state = {
            apiKey: localStorage.getItem('apiKey') || '',
            goalTime: localStorage.getItem('goalTime') || '1:59:59',
            raceDate: localStorage.getItem('raceDate') || '2026-03-22',
            activities: JSON.parse(localStorage.getItem('activities') || '[]'),
            kneeStatus: localStorage.getItem('kneeStatus') || 'green',
            kneeHistory: JSON.parse(localStorage.getItem('kneeHistory') || '[]'),
            // Multi-chat support
            chats: chatsData,
            currentChatId: localStorage.getItem('currentChatId') || getFirstChatId(chatsData),
            // Legacy - kept for compatibility, points to current chat messages
            get messages() { return this.chats[this.currentChatId]?.messages || []; },
            set messages(val) { if (this.chats[this.currentChatId]) this.chats[this.currentChatId].messages = val; },
            hasSeenSplash: localStorage.getItem('hasSeenSplash') === 'true',
            userContext: localStorage.getItem('userContext') || '',
            tone: localStorage.getItem('tone') || 'motivierend',
            calorieGoal: parseInt(localStorage.getItem('calorieGoal')) || 2100,
            weight: parseFloat(localStorage.getItem('weight')) || 87.5,
            stravaConnected: localStorage.getItem('stravaConnected') === 'true',
            stravaActivities: JSON.parse(localStorage.getItem('stravaActivities') || '[]'),
            currentNutritionDate: new Date().toISOString().split('T')[0],
            // Garmin Connect data
            garminConnected: localStorage.getItem('garminConnected') === 'true',
            garminData: JSON.parse(localStorage.getItem('garminData') || '{}'),
            // Structure: { sleepHours, sleepScore, hrv, hrvAvg7d, restingHR, restingHRAvg7d, steps, vo2max, bodyBattery, stressLevel, lastSync }
        };

        // Computed protein goal (2g per kg)
        function getProteinGoal() {
            return Math.round(state.weight * 2);
        }

        // ============== READINESS SCORE ==============
        function calculateReadinessScore() {
            let score = 10; // Start at max
            const warnings = [];
            const g = state.garminData;

            // 1. KNEE STATUS (highest priority)
            if (state.kneeStatus === 'red') {
                score = Math.min(score, 2);
                warnings.push('Knie: Schmerzen - kein Lauftraining!');
            } else if (state.kneeStatus === 'yellow') {
                score -= 2;
                warnings.push('Knie: Leichte Beschwerden - kein Tempo');
            }

            // 2. SLEEP (if Garmin data available)
            if (g.sleepHours) {
                if (g.sleepHours < 5) {
                    score -= 2;
                    warnings.push(`Schlaf: Nur ${g.sleepHours}h - stark reduziert`);
                } else if (g.sleepHours < 6) {
                    score -= 1;
                    warnings.push(`Schlaf: ${g.sleepHours}h - unter optimal`);
                }
            }

            // 3. HRV (Heart Rate Variability)
            if (g.hrv && g.hrvAvg7d) {
                const hrvDiff = ((g.hrv - g.hrvAvg7d) / g.hrvAvg7d) * 100;
                if (hrvDiff < -15) {
                    score -= 2;
                    warnings.push(`HRV: ${Math.round(hrvDiff)}% unter Durchschnitt`);
                } else if (hrvDiff < -5) {
                    score -= 1;
                    warnings.push(`HRV: Leicht unter Durchschnitt`);
                }
            }

            // 4. RESTING HEART RATE
            if (g.restingHR && g.restingHRAvg7d) {
                const hrDiff = g.restingHR - g.restingHRAvg7d;
                if (hrDiff > 5) {
                    score -= 1;
                    warnings.push(`Ruhepuls: +${Math.round(hrDiff)} bpm erh√∂ht`);
                }
            }

            // 5. BODY BATTERY (Garmin-specific)
            if (g.bodyBattery !== undefined) {
                if (g.bodyBattery < 25) {
                    score -= 2;
                    warnings.push(`Body Battery: Nur ${g.bodyBattery}% - stark ersch√∂pft`);
                } else if (g.bodyBattery < 50) {
                    score -= 1;
                    warnings.push(`Body Battery: ${g.bodyBattery}% - m√§√üig`);
                }
            }

            // 6. STEPS (low = recovery day, bonus)
            if (g.stepsYesterday !== undefined && g.stepsYesterday < 3000) {
                score += 0.5;
                // No warning, this is positive
            }

            // Clamp score between 0 and 10
            score = Math.max(0, Math.min(10, score));

            // Generate recommendation
            let recommendation, limit;
            if (score <= 2) {
                recommendation = 'Ruhetag';
                limit = 'Kein Training empfohlen';
            } else if (score <= 4) {
                recommendation = 'Leichte Aktivit√§t';
                limit = 'Max. 20 Min. lockeres Gehen/Dehnen';
            } else if (score <= 6) {
                recommendation = 'Moderates Training';
                limit = 'Max. 45 Min. Zone 2';
            } else if (score <= 8) {
                recommendation = 'Normales Training';
                limit = 'Planm√§√üig, aber achtsam';
            } else {
                recommendation = 'Volle Kapazit√§t';
                limit = 'Intensit√§t nach Plan m√∂glich';
            }

            return {
                score: Math.round(score * 10) / 10,
                recommendation,
                limit,
                warnings,
                color: score <= 3 ? '#fc8181' : score <= 6 ? '#ecc94b' : '#48bb78'
            };
        }

        // Helper functions
        function formatDate(date) {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            return `${days[date.getDay()]}, ${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatShortDate(date) {
            return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth()+1).toString().padStart(2, '0')}.`;
        }

        function getDaysUntilRace() {
            const raceDate = new Date(state.raceDate);
            const today = new Date();
            return Math.ceil((raceDate - today) / (1000 * 60 * 60 * 24));
        }

        function getDateKey(dateStr) {
            return `meals_${dateStr}`;
        }

        function getMealsForDate(dateStr) {
            return JSON.parse(localStorage.getItem(getDateKey(dateStr)) || '[]');
        }

        function saveMealsForDate(dateStr, meals) {
            localStorage.setItem(getDateKey(dateStr), JSON.stringify(meals));
        }

        // Toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Generate DYNAMIC training context - NO hardcoded plan!
        function generateTrainingContext() {
            const today = new Date();
            const daysUntilRace = getDaysUntilRace();
            const weeksUntilRace = Math.ceil(daysUntilRace / 7);

            // Get recent activities for context
            const recentActivities = [...state.activities, ...state.stravaActivities]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            const activitiesSummary = recentActivities.length > 0
                ? recentActivities.map(a => {
                    const date = new Date(a.date).toLocaleDateString('de-DE');
                    const type = a.type || 'run';
                    const dist = a.distance ? `${a.distance}km` : '';
                    const dur = a.duration ? `${a.duration}min` : '';
                    const knee = a.kneeStatus ? `(Knie: ${a.kneeStatus})` : '';
                    return `- ${date}: ${type} ${dist} ${dur} ${knee}`.trim();
                }).join('\n')
                : 'Noch keine Aktivit√§ten aufgezeichnet.';

            // Calculate weekly stats
            const thisWeekStart = new Date(today);
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            thisWeekStart.setDate(today.getDate() - diff);
            thisWeekStart.setHours(0,0,0,0);

            const thisWeekActivities = [...state.activities, ...state.stravaActivities]
                .filter(a => new Date(a.date) >= thisWeekStart && a.type === 'run');
            const thisWeekKmRaw = thisWeekActivities.reduce((sum, a) => {
                const dist = parseFloat(a.distance);
                return sum + (isNaN(dist) ? 0 : dist);
            }, 0);
            const thisWeekKm = isNaN(thisWeekKmRaw) ? 0 : thisWeekKmRaw;

            // Knee history
            const kneeHistorySummary = state.kneeHistory.slice(-7).map(k =>
                `${new Date(k.date).toLocaleDateString('de-DE')}: ${k.status}`
            ).join(', ') || 'Keine Historie';

            // Tone mapping
            const toneMap = {
                'motivierend': 'Sei motivierend und positiv. Feiere Erfolge!',
                'sachlich': 'Sei sachlich und direkt. Fokus auf Fakten.',
                'freundlich': 'Sei freundlich und locker.',
                'streng': 'Sei streng und fordernd. Push mich!'
            };

            return `Du bist ein erfahrener KI-Laufcoach spezialisiert auf Comeback nach Verletzungen.

HEUTE: ${formatDate(today)}
ZIEL: Halbmarathon Madrid am 22. M√§rz 2026 (in ${daysUntilRace} Tagen / ${weeksUntilRace} Wochen)
ZIELZEIT: ${state.goalTime} (ambitioniert nach Verletzung)

WICHTIG √úBER DEN ATHLETEN (Fabian):
- Teilruptur vorderes Kreuzband (VKB), war 3 Monate pausiert
- Comeback-Phase: Erst seit wenigen Wochen wieder im Training
- Vor Verletzung: Hobby-L√§ufer mit 15-30 km/Woche
- Ausr√ºstung: Garmin Forerunner 255, nutzt Strava
${state.userContext ? `- Zus√§tzlicher Kontext: ${state.userContext}` : ''}

‚ö†Ô∏è AKTUELLER KNIE-STATUS: ${state.kneeStatus === 'green' ? 'üü¢ GR√úN (OK)' : state.kneeStatus === 'yellow' ? 'üü° GELB (Vorsicht!)' : 'üî¥ ROT (Pause!)'}
Knie-Verlauf letzte Tage: ${kneeHistorySummary}

üìä TRAININGSHISTORIE:
Diese Woche bisher: ${(Number(thisWeekKm) || 0).toFixed(1)} km
Letzte Aktivit√§ten:
${activitiesSummary}

üéØ DEINE AUFGABE:
1. Erstelle INDIVIDUELLE Trainingspl√§ne basierend auf den ECHTEN Aktivit√§ten oben
2. Passe SOFORT an den Knie-Status an:
   - GR√úN: Normales Training m√∂glich
   - GELB: Reduziere Intensit√§t/Umfang um 30-50%, empfehle Alternativen (Schwimmen, Rad)
   - ROT: NUR Pause, Mobility, ggf. Arztbesuch empfehlen
3. Ber√ºcksichtige die bisherige Belastung der Woche
4. Sei realistisch: Nach VKB-Teilruptur ist Vorsicht wichtiger als Tempo

üçΩÔ∏è ERN√ÑHRUNG HEUTE (${today.toLocaleDateString('de-DE')}):
${generateNutritionContext()}

KOMMUNIKATIONSSTIL:
${toneMap[state.tone]}
- Antworte auf Deutsch
- Formatiere mit Markdown (### √úberschriften, **fett**, Listen)
- Halte Antworten kompakt aber hilfreich`;
        }

        // Generate nutrition context for chat
        function generateNutritionContext() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todaysMeals = getMealsForDate(todayStr);

            if (todaysMeals.length === 0) {
                return 'Noch nichts gegessen heute.';
            }

            const totals = todaysMeals.reduce((acc, meal) => ({
                kcal: acc.kcal + (meal.kcal || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0)
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

            const proteinGoal = getProteinGoal();
            const activityKcal = [...state.activities, ...state.stravaActivities]
                .filter(a => a.date === todayStr)
                .reduce((sum, a) => sum + (a.calories || (parseInt(a.duration) || 0) * 10), 0);

            const totalBudget = state.calorieGoal + activityKcal;
            const remaining = totalBudget - totals.kcal;

            let mealsList = todaysMeals.map(m => `- ${m.time}: ${m.name} (${m.kcal} kcal, ${m.protein}g Protein)`).join('\n');

            return `${mealsList}
SUMME: ${totals.kcal}/${totalBudget} kcal (noch ${remaining} kcal √ºbrig)
PROTEIN: ${totals.protein}/${proteinGoal}g (${Math.round(totals.protein/proteinGoal*100)}% erreicht)
${totals.protein < proteinGoal * 0.5 ? '‚ö†Ô∏è Protein-Defizit! Empfehle proteinreiche Mahlzeit.' : totals.protein >= proteinGoal ? '‚úÖ Protein-Ziel erreicht!' : ''}`;
        }

        // Update countdown
        function updateCountdown() {
            const daysUntilRace = getDaysUntilRace();
            document.getElementById('countdown-days').textContent = daysUntilRace;
            document.getElementById('countdown-date').textContent = formatDate(new Date(state.raceDate));
        }

        // Update knee display
        function updateKneeDisplay() {
            document.querySelectorAll('.knee-dot').forEach(dot => dot.classList.remove('active'));
            document.querySelector(`.knee-dot.${state.kneeStatus}`).classList.add('active');

            const infoMap = {
                green: '‚úÖ Alles OK - Training m√∂glich',
                yellow: '‚ö†Ô∏è Vorsicht - Reduziertes Training empfohlen',
                red: 'üõë Pause - Kein Lauftraining heute!'
            };
            document.getElementById('knee-info').textContent = infoMap[state.kneeStatus];
        }

        // Set knee status with history tracking
        function setKneeStatus(status) {
            const oldStatus = state.kneeStatus;
            state.kneeStatus = status;
            localStorage.setItem('kneeStatus', status);

            // Save to history
            const today = new Date().toISOString().split('T')[0];
            const existingToday = state.kneeHistory.findIndex(k => k.date === today);
            if (existingToday >= 0) {
                state.kneeHistory[existingToday].status = status;
            } else {
                state.kneeHistory.push({ date: today, status });
            }
            localStorage.setItem('kneeHistory', JSON.stringify(state.kneeHistory.slice(-30)));

            updateKneeDisplay();
            updateReadinessDisplay(); // Update Readiness Score when knee changes

            // If status changed to yellow/red, offer advice
            if (status !== 'green' && status !== oldStatus) {
                showScreen('chat');
                setTimeout(() => {
                    const msg = status === 'yellow'
                        ? 'Mein Knie f√ºhlt sich heute nicht 100% an (gelb). Was empfiehlst du f√ºr heute?'
                        : 'Mein Knie schmerzt heute (rot). Was soll ich tun?';
                    askCoach(msg);
                }, 300);
            }
        }

        // ============== MULTI-CHAT SYSTEM ==============

        // Save all chats to localStorage
        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(state.chats));
            localStorage.setItem('currentChatId', state.currentChatId);
        }

        // Create a new chat
        function createNewChat() {
            const chatId = generateChatId();
            state.chats[chatId] = {
                id: chatId,
                title: 'Neuer Chat',
                messages: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };
            state.currentChatId = chatId;
            saveChats();
            loadMessages();
            updateChatHeader();
            closeChatList();
        }

        // Switch to a different chat
        function switchToChat(chatId) {
            if (state.chats[chatId]) {
                state.currentChatId = chatId;
                saveChats();
                loadMessages();
                updateChatHeader();
                closeChatList();
            }
        }

        // Delete a chat
        function deleteChat(chatId, event) {
            event.stopPropagation();
            const chatCount = Object.keys(state.chats).length;

            if (chatCount <= 1) {
                showToast('Letzter Chat kann nicht gel√∂scht werden', true);
                return;
            }

            if (!confirm('Diesen Chat wirklich l√∂schen?')) return;

            delete state.chats[chatId];

            // If deleted current chat, switch to another
            if (state.currentChatId === chatId) {
                state.currentChatId = getFirstChatId(state.chats);
            }

            saveChats();
            renderChatList();
            loadMessages();
            updateChatHeader();
        }

        // Open chat list modal
        function openChatList() {
            renderChatList();
            document.getElementById('chat-list-modal').classList.remove('hidden');
        }

        // Close chat list modal
        function closeChatList(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('chat-list-modal').classList.add('hidden');
        }

        // Render the chat list
        function renderChatList() {
            const container = document.getElementById('chat-list');
            const sortedChats = Object.values(state.chats).sort((a, b) => b.updatedAt - a.updatedAt);

            container.innerHTML = sortedChats.map(chat => {
                const isActive = chat.id === state.currentChatId;
                const lastMsg = chat.messages[chat.messages.length - 1];
                const preview = lastMsg ? (lastMsg.content.substring(0, 50) + (lastMsg.content.length > 50 ? '...' : '')) : 'Keine Nachrichten';
                const date = new Date(chat.updatedAt).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                return `
                    <div class="chat-list-item ${isActive ? 'active' : ''}" onclick="switchToChat('${chat.id}')">
                        <div class="chat-list-item-info">
                            <div class="chat-list-item-title">${escapeHtml(chat.title)}</div>
                            <div class="chat-list-item-preview">${escapeHtml(preview)}</div>
                        </div>
                        <span class="chat-list-item-date">${date}</span>
                        <button class="chat-delete-btn" onclick="deleteChat('${chat.id}', event)" title="L√∂schen">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        // Update chat header with current chat title
        function updateChatHeader() {
            const titleEl = document.getElementById('current-chat-title');
            const currentChat = state.chats[state.currentChatId];
            if (titleEl && currentChat) {
                titleEl.textContent = currentChat.title;
            }
        }

        // Auto-generate chat title from first user message
        function updateChatTitleFromMessage(message) {
            const currentChat = state.chats[state.currentChatId];
            if (currentChat && currentChat.title === 'Neuer Chat' && currentChat.messages.length <= 2) {
                // Generate title from first user message (max 30 chars)
                const title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                currentChat.title = title;
                updateChatHeader();
            }
        }

        // Get all messages across all chats for context (shared memory)
        function getAllChatContext() {
            const allChats = Object.values(state.chats).sort((a, b) => b.updatedAt - a.updatedAt);
            let context = '';

            // Get summary of other chats (not current)
            const otherChats = allChats.filter(c => c.id !== state.currentChatId);
            if (otherChats.length > 0) {
                context = '\n\n[KONTEXT AUS FR√úHEREN CHATS:]\n';
                otherChats.slice(0, 5).forEach(chat => {
                    if (chat.messages.length > 0) {
                        const summary = chat.messages.slice(-3).map(m =>
                            `${m.role === 'user' ? 'User' : 'Coach'}: ${m.content.substring(0, 100)}...`
                        ).join('\n');
                        context += `\n--- ${chat.title} ---\n${summary}\n`;
                    }
                });
            }
            return context;
        }

        // Load messages
        function loadMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';

            // Add welcome message if no messages
            if (state.messages.length === 0) {
                addMessageToUI('assistant', 'Hallo! üëã Ich bin dein KI-Fitness-Coach. Ich erstelle dir einen individuellen Trainingsplan basierend auf deinen Strava-Aktivit√§ten und deinem aktuellen Knie-Status. Wie kann ich dir heute helfen?', false);
            } else {
                state.messages.forEach((msg, index) => addMessageToUI(msg.role, msg.content, false, index));
            }

            updateChatHeader();
        }

        // Add message to UI with delete button
        function addMessageToUI(role, content, save = true, index = null) {
            const container = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = `message-container ${role}`;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = role === 'assistant' ? parseMarkdown(content) : escapeHtml(content);
            wrapper.appendChild(msgDiv);

            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'message-delete';
            deleteBtn.textContent = 'L√∂schen';
            const msgIndex = index !== null ? index : state.messages.length;
            deleteBtn.onclick = () => deleteMessage(msgIndex);
            wrapper.appendChild(deleteBtn);

            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;

            if (save) {
                state.messages.push({ role, content });
                // Update current chat's updatedAt
                if (state.chats[state.currentChatId]) {
                    state.chats[state.currentChatId].updatedAt = Date.now();
                }
                // Auto-generate title from first user message
                if (role === 'user') {
                    updateChatTitleFromMessage(content);
                }
                // Save to multi-chat storage
                saveChats();
            }
        }

        // Delete single message
        function deleteMessage(index) {
            state.messages.splice(index, 1);
            saveChats();
            loadMessages();
        }

        // Clear current chat history (keeps the chat, just clears messages)
        function clearChatHistory() {
            if (confirm('M√∂chtest du wirklich diesen Chat-Verlauf l√∂schen?')) {
                if (state.chats[state.currentChatId]) {
                    state.chats[state.currentChatId].messages = [];
                    state.chats[state.currentChatId].title = 'Neuer Chat';
                }
                saveChats();
                loadMessages();
                closeSettings();
            }
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function parseMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '').replace(/<p>(<h[123]>)/g, '$1').replace(/(<\/h[123]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1').replace(/(<\/ul>)<\/p>/g, '$1');
            return html;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing');
            if (indicator) indicator.remove();
        }

        // Send message to Claude
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';
            addMessageToUI('user', message);

            if (!state.apiKey) {
                addMessageToUI('assistant', 'Bitte gib zuerst deinen Claude API Key in den Einstellungen ein (‚öôÔ∏è oben rechts).');
                return;
            }

            showTypingIndicator();

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: generateTrainingContext() + getAllChatContext(),
                        messages: [
                            ...state.messages.slice(-10).map(m => ({
                                role: m.role === 'assistant' ? 'assistant' : 'user',
                                content: m.content
                            })),
                            { role: 'user', content: message }
                        ]
                    })
                });

                hideTypingIndicator();

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                addMessageToUI('assistant', data.content[0].text);
            } catch (error) {
                hideTypingIndicator();
                addMessageToUI('assistant', `Fehler: ${error.message}`);
            }
        }

        // Nutrition Date Navigation
        function changeNutritionDate(delta) {
            const current = new Date(state.currentNutritionDate);
            current.setDate(current.getDate() + delta);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Don't allow future dates
            if (current > today) return;

            state.currentNutritionDate = current.toISOString().split('T')[0];
            updateNutritionDisplay();
        }

        function goToNutritionToday() {
            state.currentNutritionDate = new Date().toISOString().split('T')[0];
            updateNutritionDisplay();
        }

        // ============== FOOD SEARCH (Open Food Facts) ==============
        let searchTimeout = null;
        let barcodeDetector = null;
        let videoStream = null;

        async function searchFood() {
            const query = document.getElementById('food-search').value.trim();
            const resultsContainer = document.getElementById('search-results');

            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                resultsContainer.innerHTML = '<div class="search-loading">Suche...</div>';
                resultsContainer.classList.remove('hidden');

                try {
                    // Search Open Food Facts (German products)
                    const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=10&countries_tags=germany`);
                    const data = await response.json();

                    if (data.products && data.products.length > 0) {
                        resultsContainer.innerHTML = data.products.map(p => {
                            const name = p.product_name || 'Unbekannt';
                            const brand = p.brands || '';
                            const kcal = Math.round(p.nutriments?.['energy-kcal_100g'] || p.nutriments?.['energy-kcal'] || 0);
                            const protein = Math.round(p.nutriments?.proteins_100g || 0);
                            const carbs = Math.round(p.nutriments?.carbohydrates_100g || 0);
                            const fat = Math.round(p.nutriments?.fat_100g || 0);
                            const serving = p.serving_size || '100g';

                            return `
                                <div class="search-result-item" onclick='selectFoodProduct(${JSON.stringify({
                                    name: (brand ? brand + ' ' : '') + name,
                                    kcal, protein, carbs, fat, serving,
                                    kcal100g: kcal, protein100g: protein, carbs100g: carbs, fat100g: fat
                                })})'>
                                    <div class="result-name">${name}</div>
                                    ${brand ? `<div class="result-brand">${brand}</div>` : ''}
                                    <div class="result-macros">${kcal} kcal ¬∑ ${protein}g P ¬∑ ${carbs}g K ¬∑ ${fat}g F (pro 100g)</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        resultsContainer.innerHTML = `
                            <div class="search-empty">Keine Produkte gefunden</div>
                            <div class="ai-fallback" onclick="useAiForSearch()">ü§ñ Per KI sch√§tzen: "${query}"</div>
                        `;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    resultsContainer.innerHTML = `
                        <div class="search-empty">Suche fehlgeschlagen</div>
                        <div class="ai-fallback" onclick="useAiForSearch()">ü§ñ Per KI sch√§tzen: "${query}"</div>
                    `;
                }
            }, 300); // Debounce 300ms
        }

        function handleFoodSearchKeydown(event) {
            if (event.key === 'Escape') {
                document.getElementById('search-results').classList.add('hidden');
            }
        }

        // ============== PORTION SELECTION ==============
        let currentProduct = null;
        let selectedPortionGrams = 100;

        // Standard portion sizes
        const PORTION_PRESETS = [
            { name: '100g', grams: 100, icon: '‚öñÔ∏è' },
            { name: '1 Portion', grams: 150, icon: 'üçΩÔ∏è' },
            { name: '1 Becher', grams: 150, icon: 'ü•õ' },
            { name: '1 Glas (200ml)', grams: 200, icon: 'ü•§' },
            { name: '1 Flasche (500ml)', grams: 500, icon: 'üçº' },
            { name: '1 Flasche (330ml)', grams: 330, icon: 'üß¥' },
            { name: '1 Dose (330ml)', grams: 330, icon: 'ü•´' },
            { name: '1 Riegel', grams: 40, icon: 'üç´' },
        ];

        function selectFoodProduct(product) {
            currentProduct = product;
            selectedPortionGrams = 100;

            // Show product info
            document.getElementById('portion-product-name').textContent = product.name;
            document.getElementById('portion-base-info').textContent =
                `${product.kcal100g} kcal ¬∑ ${product.protein100g}g P ¬∑ ${product.carbs100g}g K ¬∑ ${product.fat100g}g F pro 100g`;

            // Build portion options
            const optionsHtml = PORTION_PRESETS.map((preset, idx) => `
                <div class="portion-option ${idx === 0 ? 'selected' : ''}" onclick="selectPortion(${preset.grams}, this)">
                    <span class="portion-option-icon">${preset.icon}</span>
                    <div class="portion-option-info">
                        <div class="portion-option-name">${preset.name}</div>
                        <div class="portion-option-amount">${preset.grams}g</div>
                    </div>
                </div>
            `).join('') + `
                <div class="portion-custom">
                    <div class="portion-custom-label">Eigene Menge eingeben:</div>
                    <div class="portion-custom-input">
                        <input type="number" id="custom-portion-input" placeholder="Gramm" min="1" oninput="updateCustomPortion(this.value)">
                        <span style="color: var(--text-secondary); align-self: center;">g</span>
                    </div>
                </div>
            `;
            document.getElementById('portion-options').innerHTML = optionsHtml;

            // Update preview
            updatePortionPreview();

            // Show modal
            document.getElementById('portion-modal').classList.remove('hidden');
            document.getElementById('search-results').classList.add('hidden');
        }

        function selectPortion(grams, element) {
            selectedPortionGrams = grams;

            // Update selection UI
            document.querySelectorAll('.portion-option').forEach(el => el.classList.remove('selected'));
            if (element) element.classList.add('selected');

            // Clear custom input
            const customInput = document.getElementById('custom-portion-input');
            if (customInput) customInput.value = '';

            updatePortionPreview();
        }

        function updateCustomPortion(value) {
            const grams = parseInt(value) || 0;
            if (grams > 0) {
                selectedPortionGrams = grams;
                // Deselect presets
                document.querySelectorAll('.portion-option').forEach(el => el.classList.remove('selected'));
                updatePortionPreview();
            }
        }

        function updatePortionPreview() {
            if (!currentProduct) return;
            const multiplier = selectedPortionGrams / 100;

            document.getElementById('portion-kcal').textContent = Math.round(currentProduct.kcal100g * multiplier);
            document.getElementById('portion-protein').textContent = Math.round(currentProduct.protein100g * multiplier * 10) / 10 + 'g';
            document.getElementById('portion-carbs').textContent = Math.round(currentProduct.carbs100g * multiplier * 10) / 10 + 'g';
            document.getElementById('portion-fat').textContent = Math.round(currentProduct.fat100g * multiplier * 10) / 10 + 'g';
        }

        function closePortionModal() {
            document.getElementById('portion-modal').classList.add('hidden');
            currentProduct = null;
        }

        function confirmPortion() {
            if (!currentProduct) return;

            const multiplier = selectedPortionGrams / 100;
            const mealData = {
                name: currentProduct.name,
                kcal: Math.round(currentProduct.kcal100g * multiplier),
                protein: Math.round(currentProduct.protein100g * multiplier * 10) / 10,
                carbs: Math.round(currentProduct.carbs100g * multiplier * 10) / 10,
                fat: Math.round(currentProduct.fat100g * multiplier * 10) / 10,
                time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
                id: Date.now(),
                portion: selectedPortionGrams + 'g',
                source: 'openfoodfacts'
            };

            const meals = getMealsForDate(state.currentNutritionDate);
            meals.push(mealData);
            saveMealsForDate(state.currentNutritionDate, meals);

            document.getElementById('food-search').value = '';
            closePortionModal();
            updateNutritionDisplay();
            showToast(`‚úì ${mealData.name} (${mealData.kcal} kcal)`);
        }

        function useAiForSearch() {
            const query = document.getElementById('food-search').value.trim();
            document.getElementById('meal-input').value = query;
            document.getElementById('ai-input-section').classList.remove('hidden');
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('food-search').value = '';
        }

        function toggleAiInput() {
            const aiSection = document.getElementById('ai-input-section');
            aiSection.classList.toggle('hidden');
        }

        // ============== BARCODE SCANNER ==============
        async function openBarcodeScanner() {
            const modal = document.getElementById('scanner-modal');
            const video = document.getElementById('scanner-video');

            // Check BarcodeDetector FIRST before requesting camera
            if (!('BarcodeDetector' in window)) {
                const barcode = prompt('Barcode-Scanner nicht verf√ºgbar in diesem Browser.\nBarcode manuell eingeben:');
                if (barcode && barcode.trim()) {
                    lookupBarcode(barcode.trim());
                }
                return;
            }

            try {
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = videoStream;
                modal.classList.remove('hidden');

                // Wait for video to be ready before starting detection
                video.onloadedmetadata = () => {
                    video.play();
                    barcodeDetector = new BarcodeDetector({
                        formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                    });
                    // Small delay to ensure video is fully rendering
                    setTimeout(() => detectBarcode(), 500);
                };
            } catch (error) {
                console.error('Camera error:', error);
                showToast('Kamera-Zugriff verweigert', true);
                // Offer manual entry as fallback
                const barcode = prompt('Kamera nicht verf√ºgbar. Barcode manuell eingeben:');
                if (barcode && barcode.trim()) {
                    lookupBarcode(barcode.trim());
                }
            }
        }

        async function detectBarcode() {
            const video = document.getElementById('scanner-video');
            if (!barcodeDetector || !videoStream) return;

            // Make sure video is ready
            if (video.readyState < 2) {
                requestAnimationFrame(detectBarcode);
                return;
            }

            try {
                const barcodes = await barcodeDetector.detect(video);
                if (barcodes.length > 0) {
                    const barcode = barcodes[0].rawValue;
                    console.log('Barcode detected:', barcode);
                    // Vibrate for feedback if available
                    if (navigator.vibrate) navigator.vibrate(200);
                    closeBarcodeScanner();
                    lookupBarcode(barcode);
                    return;
                }
            } catch (error) {
                // Silently continue - detection errors are normal
            }

            // Continue scanning
            if (videoStream) {
                requestAnimationFrame(detectBarcode);
            }
        }

        async function lookupBarcode(barcode) {
            showToast(`Suche Barcode ${barcode}...`);

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const p = data.product;
                    selectFoodProduct({
                        name: (p.brands ? p.brands + ' ' : '') + (p.product_name || 'Produkt'),
                        kcal100g: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                        protein100g: Math.round(p.nutriments?.proteins_100g || 0),
                        carbs100g: Math.round(p.nutriments?.carbohydrates_100g || 0),
                        fat100g: Math.round(p.nutriments?.fat_100g || 0),
                        serving: p.serving_size || '100g'
                    });
                } else {
                    showToast('Produkt nicht gefunden', true);
                }
            } catch (error) {
                console.error('Barcode lookup error:', error);
                showToast('Fehler bei Barcode-Suche', true);
            }
        }

        function closeBarcodeScanner() {
            const modal = document.getElementById('scanner-modal');
            const video = document.getElementById('scanner-video');

            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            video.srcObject = null;
            modal.classList.add('hidden');
        }

        // ============== AI MEAL ANALYSIS (Fallback) ==============
        let mealAnalysisTimeout = null;

        function handleMealKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                triggerMealAnalysis();
            }
        }

        function handleMealBlur() {
            const input = document.getElementById('meal-input');
            if (input.value.trim()) {
                mealAnalysisTimeout = setTimeout(() => triggerMealAnalysis(), 500);
            }
        }

        async function triggerMealAnalysis() {
            clearTimeout(mealAnalysisTimeout);
            const input = document.getElementById('meal-input');
            const mealText = input.value.trim();
            if (!mealText || !state.apiKey) return;

            const indicator = document.getElementById('analyzing-indicator');
            indicator.classList.remove('hidden');

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 300,
                        system: 'Du bist ein Ern√§hrungsexperte. Analysiere die Mahlzeit und antworte NUR mit JSON: {"name": "Kurzbeschreibung max 30 Zeichen", "kcal": Zahl, "protein": Zahl, "carbs": Zahl, "fat": Zahl}. Sch√§tze realistisch basierend auf deutschen Portionsgr√∂√üen.',
                        messages: [{ role: 'user', content: mealText }]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const mealData = JSON.parse(jsonMatch[0]);
                    // Validate required fields
                    if (typeof mealData.kcal !== 'number' || typeof mealData.protein !== 'number') {
                        throw new Error('Ung√ºltige N√§hrwertdaten');
                    }
                    mealData.time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    mealData.id = Date.now();
                    mealData.original = mealText;

                    // Save to current date
                    const meals = getMealsForDate(state.currentNutritionDate);
                    meals.push(mealData);
                    saveMealsForDate(state.currentNutritionDate, meals);

                    input.value = '';
                    updateNutritionDisplay();
                    showToast(`‚úì ${mealData.name} (${mealData.kcal} kcal)`);
                    console.log('Meal saved:', mealData);
                } else {
                    throw new Error('Konnte JSON nicht parsen');
                }
            } catch (error) {
                console.error('Meal analysis error:', error);
                showToast('Fehler: ' + error.message, true);
            }

            indicator.classList.add('hidden');
        }

        // Update nutrition display
        function updateNutritionDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const isToday = state.currentNutritionDate === today;
            const displayDate = new Date(state.currentNutritionDate);

            // Update date nav
            const dateLabel = isToday ? 'Heute' : formatShortDate(displayDate) + ' ' + ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][displayDate.getDay()];
            document.getElementById('nutrition-date').textContent = dateLabel;
            document.getElementById('date-nav-next').disabled = isToday;

            // Show/hide meal input (only for today)
            document.getElementById('meal-input-card').style.display = isToday ? 'block' : 'none';
            document.getElementById('meals-title').textContent = isToday ? 'Heute gegessen' : `${formatShortDate(displayDate)} gegessen`;

            const todaysMeals = getMealsForDate(state.currentNutritionDate);

            const totals = todaysMeals.reduce((acc, meal) => ({
                kcal: acc.kcal + (meal.kcal || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0)
            }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

            // Activity calories from today's workouts (BOTH manual AND Strava!)
            const allTodaysActivities = [
                ...state.activities.filter(a => a.date === state.currentNutritionDate),
                ...state.stravaActivities.filter(a => a.date === state.currentNutritionDate)
            ];
            // Use Strava calories if available, otherwise estimate 10 kcal/min
            const activityKcal = allTodaysActivities.reduce((sum, a) => {
                if (a.calories) return sum + a.calories;
                return sum + ((parseInt(a.duration) || 0) * 10);
            }, 0);

            const remaining = state.calorieGoal + activityKcal - totals.kcal;

            document.getElementById('calories-remaining').textContent = Math.max(0, remaining);
            document.getElementById('calories-base').textContent = state.calorieGoal;
            document.getElementById('calories-activity').textContent = `+${activityKcal}`;
            document.getElementById('calories-food').textContent = `-${totals.kcal}`;

            const progress = Math.min(totals.kcal / (state.calorieGoal + activityKcal), 1);
            document.getElementById('calorie-progress').style.strokeDashoffset = 408 * (1 - progress);

            const proteinGoal = getProteinGoal();
            const carbsGoal = 250, fatGoal = 70;
            document.getElementById('protein-bar').style.width = `${Math.min(totals.protein / proteinGoal * 100, 100)}%`;
            document.getElementById('carbs-bar').style.width = `${Math.min(totals.carbs / carbsGoal * 100, 100)}%`;
            document.getElementById('fat-bar').style.width = `${Math.min(totals.fat / fatGoal * 100, 100)}%`;
            document.getElementById('protein-value').textContent = `${Math.round(totals.protein)}/${proteinGoal}g`;
            document.getElementById('carbs-value').textContent = `${Math.round(totals.carbs)}/${carbsGoal}g`;
            document.getElementById('fat-value').textContent = `${Math.round(totals.fat)}/${fatGoal}g`;

            const mealsContainer = document.getElementById('meals-today');
            if (todaysMeals.length === 0) {
                mealsContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Noch nichts eingetragen</div>';
            } else {
                mealsContainer.innerHTML = todaysMeals.map((meal, index) => `
                    <div class="meal-item">
                        <div class="meal-info">
                            <div class="meal-name">${meal.name}</div>
                            <div class="meal-time">${meal.time} ¬∑ P: ${meal.protein}g ¬∑ K: ${meal.carbs}g ¬∑ F: ${meal.fat}g</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="meal-kcal">${meal.kcal} kcal</div>
                            <button onclick="deleteMeal(${index})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.9rem; padding: 0.25rem;">‚úï</button>
                        </div>
                    </div>
                `).join('');
            }

            // Update weekly summary
            updateWeeklySummary();
        }

        // Delete a meal
        function deleteMeal(index) {
            const meals = getMealsForDate(state.currentNutritionDate);
            meals.splice(index, 1);
            saveMealsForDate(state.currentNutritionDate, meals);
            updateNutritionDisplay();
        }

        // Calculate weekly nutrition summary
        function updateWeeklySummary() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            let weeklyTotals = { kcal: 0, protein: 0, carbs: 0, fat: 0, days: 0 };
            let weeklyBudget = 0;
            let weeklyActivity = 0;

            // Loop through Mon-Today
            for (let i = mondayOffset; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const meals = getMealsForDate(dateStr);
                if (meals.length > 0) {
                    weeklyTotals.days++;
                    meals.forEach(m => {
                        weeklyTotals.kcal += m.kcal || 0;
                        weeklyTotals.protein += m.protein || 0;
                        weeklyTotals.carbs += m.carbs || 0;
                        weeklyTotals.fat += m.fat || 0;
                    });
                }

                // Daily budget
                weeklyBudget += state.calorieGoal;

                // Activity calories for this day
                const dayActivities = [
                    ...state.activities.filter(a => a.date === dateStr),
                    ...state.stravaActivities.filter(a => a.date === dateStr)
                ];
                dayActivities.forEach(a => {
                    if (a.calories) weeklyActivity += a.calories;
                    else weeklyActivity += ((parseInt(a.duration) || 0) * 10);
                });
            }

            const netBalance = weeklyBudget + weeklyActivity - weeklyTotals.kcal;
            const avgDailyDeficit = weeklyTotals.days > 0 ? Math.round(netBalance / (mondayOffset + 1)) : 0;

            let statusText = '';
            let statusColor = 'var(--text-secondary)';

            if (netBalance > 500) {
                statusText = `‚úÖ Du bist ${netBalance} kcal im Defizit! G√∂nn dir ruhig was.`;
                statusColor = 'var(--success)';
            } else if (netBalance > 0) {
                statusText = `üëç Leicht im Defizit (${netBalance} kcal). Gut auf Kurs!`;
                statusColor = 'var(--success)';
            } else if (netBalance > -300) {
                statusText = `‚öñÔ∏è Ungef√§hr ausgeglichen (${Math.abs(netBalance)} kcal dr√ºber)`;
                statusColor = 'var(--warning)';
            } else {
                statusText = `‚ö†Ô∏è ${Math.abs(netBalance)} kcal √ºber Budget. Morgen weniger essen!`;
                statusColor = 'var(--danger)';
            }

            const container = document.getElementById('weekly-summary-content');
            if (container) {
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <div>üçΩÔ∏è Gegessen: <strong>${weeklyTotals.kcal}</strong> kcal</div>
                        <div>üè† Budget: <strong>${weeklyBudget}</strong> kcal</div>
                        <div>üî• Aktivit√§t: <strong>+${weeklyActivity}</strong> kcal</div>
                        <div>üìä Bilanz: <strong style="color: ${statusColor}">${netBalance > 0 ? '-' : '+'}${Math.abs(netBalance)}</strong> kcal</div>
                    </div>
                    <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 8px; color: ${statusColor}; font-weight: 500;">
                        ${statusText}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">
                        √ò ${avgDailyDeficit > 0 ? 'Defizit' : '√úberschuss'}: ${Math.abs(avgDailyDeficit)} kcal/Tag | Protein: ${weeklyTotals.protein.toFixed(1)}g | ${weeklyTotals.days} Tage geloggt
                    </div>
                `;
            }
        }

        // Navigation & UI
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`screen-${screenId}`).classList.add('active');
            document.getElementById(`nav-${screenId}`).classList.add('active');

            if (screenId === 'nutrition') {
                // Reset to today when opening nutrition
                state.currentNutritionDate = new Date().toISOString().split('T')[0];
                updateNutritionDisplay();
            }
            if (screenId === 'training') updateActivitiesList();
        }

        function askCoach(question) {
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        function hideSplash() {
            document.getElementById('splash').classList.add('hidden');
            state.hasSeenSplash = true;
            localStorage.setItem('hasSeenSplash', 'true');
        }

        // Settings
        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('goal-time-input').value = state.goalTime;
            document.getElementById('race-date-input').value = state.raceDate;
            document.getElementById('user-context-input').value = state.userContext;
            document.getElementById('tone-select').value = state.tone;
            document.getElementById('calorie-goal-input').value = state.calorieGoal;
            document.getElementById('weight-input').value = state.weight;
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value;
            state.goalTime = document.getElementById('goal-time-input').value;
            state.raceDate = document.getElementById('race-date-input').value;
            state.userContext = document.getElementById('user-context-input').value;
            state.tone = document.getElementById('tone-select').value;
            state.calorieGoal = parseInt(document.getElementById('calorie-goal-input').value) || 2100;
            state.weight = parseFloat(document.getElementById('weight-input').value) || 87.5;

            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('goalTime', state.goalTime);
            localStorage.setItem('raceDate', state.raceDate);
            localStorage.setItem('userContext', state.userContext);
            localStorage.setItem('tone', state.tone);
            localStorage.setItem('calorieGoal', state.calorieGoal);
            localStorage.setItem('weight', state.weight);

            updateCountdown();
            updateNutritionDisplay();
            closeSettings();
        }

        // Strava OAuth Configuration
        const STRAVA_CONFIG = {
            clientId: '189263',
            clientSecret: '27c5a6b678e3a95d6e323bf9931244889c0183ae',
            redirectUri: 'https://fitness-coach-alpha-dun.vercel.app/',
            scope: 'activity:read_all'
        };

        // Connect to Strava (initiate OAuth)
        function connectStrava() {
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CONFIG.clientId}&redirect_uri=${encodeURIComponent(STRAVA_CONFIG.redirectUri)}&response_type=code&scope=${STRAVA_CONFIG.scope}`;
            window.location.href = authUrl;
        }

        // Handle Strava OAuth callback
        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (!code) return;

            // Clear URL params
            window.history.replaceState({}, document.title, window.location.pathname);

            // Show loading state
            const stravaBtn = document.getElementById('strava-btn');
            if (stravaBtn) stravaBtn.textContent = 'Verbinde...';

            try {
                // Exchange code for tokens
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: STRAVA_CONFIG.clientId,
                        client_secret: STRAVA_CONFIG.clientSecret,
                        code: code,
                        grant_type: 'authorization_code'
                    })
                });

                if (!response.ok) throw new Error('Token exchange failed');

                const data = await response.json();

                // Save tokens
                localStorage.setItem('stravaAccessToken', data.access_token);
                localStorage.setItem('stravaRefreshToken', data.refresh_token);
                localStorage.setItem('stravaTokenExpiry', data.expires_at);
                localStorage.setItem('stravaAthlete', JSON.stringify(data.athlete));
                localStorage.setItem('stravaConnected', 'true');

                state.stravaConnected = true;
                updateStravaUI();

                // Fetch activities
                await fetchStravaActivities();

            } catch (error) {
                console.error('Strava auth error:', error);
                alert('Strava-Verbindung fehlgeschlagen: ' + error.message);
            }
        }

        // Refresh Strava token if expired
        async function refreshStravaToken() {
            const refreshToken = localStorage.getItem('stravaRefreshToken');
            if (!refreshToken) return null;

            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: STRAVA_CONFIG.clientId,
                        client_secret: STRAVA_CONFIG.clientSecret,
                        refresh_token: refreshToken,
                        grant_type: 'refresh_token'
                    })
                });

                if (!response.ok) throw new Error('Token refresh failed');

                const data = await response.json();
                localStorage.setItem('stravaAccessToken', data.access_token);
                localStorage.setItem('stravaRefreshToken', data.refresh_token);
                localStorage.setItem('stravaTokenExpiry', data.expires_at);

                return data.access_token;
            } catch (error) {
                console.error('Token refresh error:', error);
                disconnectStrava();
                return null;
            }
        }

        // Get valid Strava access token
        async function getStravaToken() {
            const expiry = parseInt(localStorage.getItem('stravaTokenExpiry')) || 0;
            const now = Math.floor(Date.now() / 1000);

            if (now >= expiry - 60) { // Refresh if expiring within 60 seconds
                return await refreshStravaToken();
            }
            return localStorage.getItem('stravaAccessToken');
        }

        // Fetch activities from Strava
        async function fetchStravaActivities() {
            const token = await getStravaToken();
            if (!token) return;

            try {
                // Get activities from last 365 days (1 year)
                const after = Math.floor((Date.now() - 365 * 24 * 60 * 60 * 1000) / 1000);
                const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?after=${after}&per_page=200`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch activities');

                const activities = await response.json();

                // Transform Strava activities to our format with ALL available data
                state.stravaActivities = activities.map(a => ({
                    id: `strava_${a.id}`,
                    type: mapStravaType(a.type),
                    date: a.start_date_local.split('T')[0],
                    distance: parseFloat((a.distance / 1000).toFixed(2)), // NUMBER not string!
                    duration: Math.round(a.moving_time / 60),
                    durationSeconds: a.moving_time, // Raw seconds for precise display
                    name: a.name,
                    source: 'strava',
                    averagePace: a.type === 'Run' ? formatPace(a.moving_time, a.distance) : null,
                    heartRate: a.average_heartrate || null,
                    // Additional Strava data - Calculate calories properly based on activity type
                    calories: estimateCalories(a.type, a.distance, a.moving_time, a.average_heartrate),
                    elevation: a.total_elevation_gain || 0,
                    maxSpeed: a.max_speed ? (a.max_speed * 3.6).toFixed(1) : null, // m/s to km/h
                    avgSpeed: a.average_speed ? (a.average_speed * 3.6).toFixed(1) : null,
                    cadence: a.average_cadence || null,
                    sufferScore: a.suffer_score || null,
                    achievements: a.achievement_count || 0
                }));

                localStorage.setItem('stravaActivities', JSON.stringify(state.stravaActivities));

                updateActivitiesList();
                updateWeekStats();

            } catch (error) {
                console.error('Strava fetch error:', error);
            }
        }

        // Calculate calories based on activity type, distance, duration and weight
        function estimateCalories(stravaType, distanceMeters, durationSeconds, heartRate) {
            const weight = state.weight || 85; // Default 85kg if not set
            const distanceKm = distanceMeters / 1000;
            const durationMin = durationSeconds / 60;

            // Calories per kg per km for different activities
            const calorieFactors = {
                'Run': 1.0,        // ~1 kcal/kg/km for running
                'TrailRun': 1.1,   // Slightly more for trails
                'Walk': 0.5,       // ~0.5 kcal/kg/km for walking
                'Hike': 0.6,       // Hiking with elevation
                'Ride': 0.3,       // Cycling is more efficient
                'VirtualRide': 0.3,
                'MountainBikeRide': 0.4,
                'Swim': 0,         // Use duration-based for swimming
                'WeightTraining': 0,
                'Workout': 0,
                'Yoga': 0,
                'Elliptical': 0,
                'Crossfit': 0
            };

            // Duration-based calories (kcal per minute) for non-distance activities
            const minuteFactors = {
                'Swim': 9,           // Swimming ~9 kcal/min
                'WeightTraining': 5, // Strength ~5 kcal/min
                'Workout': 6,
                'Yoga': 3,
                'Elliptical': 8,
                'Crossfit': 10
            };

            // If we have a distance-based activity
            if (calorieFactors[stravaType] && distanceKm > 0) {
                let calories = weight * distanceKm * calorieFactors[stravaType];

                // Adjust for heart rate if available (higher HR = more calories)
                if (heartRate && heartRate > 140) {
                    calories *= 1 + (heartRate - 140) / 200; // Up to 20% bonus for high HR
                }

                return Math.round(calories);
            }

            // Duration-based activities
            if (minuteFactors[stravaType]) {
                return Math.round(durationMin * minuteFactors[stravaType]);
            }

            // Fallback: generic estimation
            return Math.round(durationMin * 7); // ~7 kcal/min average
        }

        // Map Strava activity types to our types
        function mapStravaType(stravaType) {
            const typeMap = {
                'Run': 'run',
                'Ride': 'bike',
                'VirtualRide': 'bike',
                'Swim': 'swim',
                'WeightTraining': 'strength',
                'Workout': 'strength',
                'Yoga': 'mobility',
                'Walk': 'walk',
                'Hike': 'walk',
                'Elliptical': 'crosstrainer',
                'EBikeRide': 'bike',
                'Crossfit': 'strength',
                'StairStepper': 'crosstrainer',
                'Rowing': 'swim',
                'Tennis': 'padel',
                'Squash': 'padel',
                'Badminton': 'padel',
                'Racquetball': 'padel',
                'Basketball': 'basketball',
                'Soccer': 'basketball',
                'MountainBikeRide': 'bike',
                'GravelRide': 'bike',
                'TrailRun': 'run',
                'NordicSki': 'run',
                'RollerSki': 'run',
                'Skateboard': 'mobility',
                'Golf': 'walk',
                'Handcycle': 'bike'
            };
            return typeMap[stravaType] || 'run';
        }

        // Format pace (min/km)
        function formatPace(seconds, meters) {
            if (!meters || meters === 0) return null;
            const paceSeconds = seconds / (meters / 1000);
            const mins = Math.floor(paceSeconds / 60);
            const secs = Math.round(paceSeconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')} /km`;
        }

        // Format duration as MM:SS (e.g., 37:24)
        function formatDuration(seconds) {
            if (!seconds) return null;
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Disconnect Strava
        function disconnectStrava() {
            localStorage.removeItem('stravaAccessToken');
            localStorage.removeItem('stravaRefreshToken');
            localStorage.removeItem('stravaTokenExpiry');
            localStorage.removeItem('stravaAthlete');
            localStorage.removeItem('stravaConnected');
            state.stravaConnected = false;
            state.stravaActivities = [];
            localStorage.setItem('stravaActivities', '[]');
            updateStravaUI();
            updateActivitiesList();
            updateWeekStats();
        }

        // Update Strava UI state
        function updateStravaUI() {
            const btn = document.getElementById('strava-btn');
            const syncBtn = document.getElementById('strava-sync-btn');

            if (btn) {
                if (state.stravaConnected) {
                    const athlete = JSON.parse(localStorage.getItem('stravaAthlete') || '{}');
                    btn.innerHTML = `‚úì Verbunden${athlete.firstname ? ` als ${athlete.firstname}` : ''} <span style="font-size:0.75rem; opacity:0.8;">(Trennen)</span>`;
                    btn.onclick = () => {
                        if (confirm('Strava-Verbindung trennen?')) disconnectStrava();
                    };
                } else {
                    btn.innerHTML = 'Mit Strava verbinden';
                    btn.onclick = connectStrava;
                }
            }

            // Show/hide sync button on training page
            if (syncBtn) {
                syncBtn.style.display = state.stravaConnected ? 'flex' : 'none';
            }
        }

        // Sync Strava activities manually
        async function syncStrava() {
            const syncBtn = document.getElementById('strava-sync-btn');
            if (syncBtn) {
                syncBtn.innerHTML = '‚è≥';
                syncBtn.disabled = true;
            }

            await fetchStravaActivities();

            if (syncBtn) {
                syncBtn.innerHTML = 'üîÑ';
                syncBtn.disabled = false;
            }
        }

        // ============== GARMIN CONNECT ==============

        async function connectGarmin() {
            const email = document.getElementById('garmin-email').value.trim();
            const password = document.getElementById('garmin-password').value;

            if (!email || !password) {
                showToast('Bitte Email und Passwort eingeben', true);
                return;
            }

            const btn = document.getElementById('garmin-btn');
            btn.textContent = 'Verbinde...';
            btn.disabled = true;

            // NOTE: Real Garmin API requires backend due to CORS
            // For now, we'll store credentials and use manual data entry
            // Full sync can be added via Vercel serverless function

            try {
                // Simulate connection (in reality, this would call our backend)
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Store connection state
                state.garminConnected = true;
                localStorage.setItem('garminConnected', 'true');
                localStorage.setItem('garminEmail', email);
                // Note: In production, NEVER store passwords in localStorage!
                // This is just for demo. Real implementation uses OAuth tokens.

                // Initialize with placeholder data
                state.garminData = {
                    sleepHours: null,
                    sleepScore: null,
                    hrv: null,
                    hrvAvg7d: null,
                    restingHR: null,
                    restingHRAvg7d: null,
                    steps: null,
                    stepsYesterday: null,
                    vo2max: null,
                    bodyBattery: null,
                    stressLevel: null,
                    lastSync: null
                };
                localStorage.setItem('garminData', JSON.stringify(state.garminData));

                showToast('Garmin verbunden! Gib deine Daten manuell ein oder warte auf Backend-Sync.');
                updateGarminUI();
                updateReadinessDisplay();
                closeSettings();

            } catch (error) {
                showToast('Verbindung fehlgeschlagen: ' + error.message, true);
            } finally {
                btn.textContent = '‚åö Mit Garmin verbinden';
                btn.disabled = false;
            }
        }

        function disconnectGarmin() {
            state.garminConnected = false;
            state.garminData = {};
            localStorage.removeItem('garminConnected');
            localStorage.removeItem('garminEmail');
            localStorage.removeItem('garminData');
            updateGarminUI();
            updateReadinessDisplay();
        }

        // Manual Garmin data entry (until backend sync is implemented)
        function openGarminDataEntry() {
            const g = state.garminData;
            const html = `
                <div style="padding: 1rem;">
                    <h3 style="margin-bottom: 1rem;">Garmin Daten eingeben</h3>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Gib deine heutigen Werte von der Garmin Watch ein:
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-secondary);">Schlaf (Stunden)</label>
                            <input type="number" step="0.5" id="g-sleep" class="form-input" value="${g.sleepHours || ''}" placeholder="z.B. 7.5">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-secondary);">Body Battery (%)</label>
                            <input type="number" id="g-battery" class="form-input" value="${g.bodyBattery || ''}" placeholder="z.B. 75">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-secondary);">HRV (ms)</label>
                            <input type="number" id="g-hrv" class="form-input" value="${g.hrv || ''}" placeholder="z.B. 45">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-secondary);">Ruhepuls (bpm)</label>
                            <input type="number" id="g-rhr" class="form-input" value="${g.restingHR || ''}" placeholder="z.B. 52">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-secondary);">Schritte gestern</label>
                            <input type="number" id="g-steps" class="form-input" value="${g.stepsYesterday || ''}" placeholder="z.B. 8500">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-secondary);">VO2max</label>
                            <input type="number" id="g-vo2" class="form-input" value="${g.vo2max || ''}" placeholder="z.B. 48">
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="saveGarminData()" style="flex: 1;">Speichern</button>
                        <button class="btn btn-secondary" onclick="closeGarminDataEntry()">Abbrechen</button>
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.id = 'garmin-entry-modal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `<div class="modal" style="max-width: 400px;">${html}</div>`;
            modal.onclick = (e) => { if (e.target === modal) closeGarminDataEntry(); };
            document.body.appendChild(modal);
        }

        function closeGarminDataEntry() {
            const modal = document.getElementById('garmin-entry-modal');
            if (modal) modal.remove();
        }

        function saveGarminData() {
            const g = state.garminData;

            const sleepVal = parseFloat(document.getElementById('g-sleep').value);
            const batteryVal = parseInt(document.getElementById('g-battery').value);
            const hrvVal = parseInt(document.getElementById('g-hrv').value);
            const rhrVal = parseInt(document.getElementById('g-rhr').value);
            const stepsVal = parseInt(document.getElementById('g-steps').value);
            const vo2Val = parseInt(document.getElementById('g-vo2').value);

            // Update values if provided
            if (!isNaN(sleepVal)) g.sleepHours = sleepVal;
            if (!isNaN(batteryVal)) g.bodyBattery = batteryVal;
            if (!isNaN(hrvVal)) {
                // Update 7-day average
                if (g.hrv) {
                    g.hrvAvg7d = g.hrvAvg7d ? (g.hrvAvg7d * 0.85 + g.hrv * 0.15) : g.hrv;
                }
                g.hrv = hrvVal;
                if (!g.hrvAvg7d) g.hrvAvg7d = hrvVal;
            }
            if (!isNaN(rhrVal)) {
                if (g.restingHR) {
                    g.restingHRAvg7d = g.restingHRAvg7d ? (g.restingHRAvg7d * 0.85 + g.restingHR * 0.15) : g.restingHR;
                }
                g.restingHR = rhrVal;
                if (!g.restingHRAvg7d) g.restingHRAvg7d = rhrVal;
            }
            if (!isNaN(stepsVal)) g.stepsYesterday = stepsVal;
            if (!isNaN(vo2Val)) g.vo2max = vo2Val;

            g.lastSync = new Date().toISOString();

            localStorage.setItem('garminData', JSON.stringify(g));
            closeGarminDataEntry();
            updateGarminUI();
            updateReadinessDisplay();
            showToast('Garmin Daten gespeichert');
        }

        function syncGarmin() {
            // For now, open manual entry
            // Later: call backend to fetch real data
            openGarminDataEntry();
        }

        function updateGarminUI() {
            const btn = document.getElementById('garmin-btn');
            const statusEl = document.getElementById('garmin-status');
            const syncBtn = document.getElementById('garmin-sync-btn');
            const contentEl = document.getElementById('garmin-content');

            if (btn) {
                if (state.garminConnected) {
                    const email = localStorage.getItem('garminEmail') || '';
                    btn.innerHTML = `‚úì Verbunden <span style="font-size:0.75rem; opacity:0.8;">(Trennen)</span>`;
                    btn.style.background = '#48bb78';
                    btn.onclick = () => {
                        if (confirm('Garmin-Verbindung trennen?')) disconnectGarmin();
                    };
                    if (statusEl) statusEl.textContent = `Verbunden als ${email}`;
                } else {
                    btn.innerHTML = '‚åö Mit Garmin verbinden';
                    btn.style.background = '#11a9ed';
                    btn.onclick = connectGarmin;
                    if (statusEl) statusEl.textContent = 'Nicht verbunden';
                }
            }

            if (syncBtn) {
                syncBtn.style.display = state.garminConnected ? 'block' : 'none';
            }

            // Update dashboard card
            if (contentEl) {
                if (state.garminConnected) {
                    const g = state.garminData;
                    contentEl.innerHTML = `
                        <div class="garmin-metrics">
                            <div class="garmin-metric" onclick="openGarminDataEntry()" style="cursor: pointer;">
                                <div class="garmin-metric-value">${g.sleepHours ? g.sleepHours + 'h' : '-'}</div>
                                <div class="garmin-metric-label">Schlaf</div>
                            </div>
                            <div class="garmin-metric" onclick="openGarminDataEntry()" style="cursor: pointer;">
                                <div class="garmin-metric-value">${g.bodyBattery !== null ? g.bodyBattery + '%' : '-'}</div>
                                <div class="garmin-metric-label">Battery</div>
                            </div>
                            <div class="garmin-metric" onclick="openGarminDataEntry()" style="cursor: pointer;">
                                <div class="garmin-metric-value">${g.hrv ? g.hrv : '-'}</div>
                                <div class="garmin-metric-label">HRV</div>
                            </div>
                            <div class="garmin-metric" onclick="openGarminDataEntry()" style="cursor: pointer;">
                                <div class="garmin-metric-value">${g.restingHR ? g.restingHR : '-'}</div>
                                <div class="garmin-metric-label">Ruhepuls</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-secondary);">
                            ${g.lastSync ? 'Aktualisiert: ' + new Date(g.lastSync).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : 'Tippe zum Eingeben'}
                        </div>
                    `;
                } else {
                    contentEl.innerHTML = `
                        <div class="garmin-not-connected">
                            Verbinde Garmin in den Einstellungen<br>
                            <small style="opacity: 0.7;">f√ºr Schlaf, HRV, Body Battery & mehr</small>
                        </div>
                    `;
                }
            }
        }

        function updateReadinessDisplay() {
            const readiness = calculateReadinessScore();

            const circleEl = document.getElementById('readiness-circle');
            const valueEl = document.getElementById('readiness-value');
            const titleEl = document.getElementById('readiness-title');
            const limitEl = document.getElementById('readiness-limit');
            const warningsEl = document.getElementById('readiness-warnings');

            if (circleEl) circleEl.style.background = readiness.color;
            if (valueEl) valueEl.textContent = readiness.score;
            if (titleEl) titleEl.textContent = readiness.recommendation;
            if (limitEl) limitEl.textContent = readiness.limit;

            if (warningsEl) {
                if (readiness.warnings.length > 0) {
                    warningsEl.innerHTML = readiness.warnings.map(w =>
                        `<div class="readiness-warning">${w}</div>`
                    ).join('');
                } else {
                    warningsEl.innerHTML = '';
                }
            }
        }

        // Activity Modal
        function openActivityModal() {
            document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('activity-knee').value = state.kneeStatus;
            document.getElementById('activity-modal').classList.add('active');
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('active');
        }

        function saveActivity() {
            const activity = {
                type: document.getElementById('activity-type').value,
                date: document.getElementById('activity-date').value,
                distance: parseFloat(document.getElementById('activity-distance').value) || 0,
                duration: parseInt(document.getElementById('activity-duration').value) || 0,
                kneeStatus: document.getElementById('activity-knee').value,
                notes: document.getElementById('activity-notes').value,
                id: Date.now()
            };

            state.activities.unshift(activity);
            localStorage.setItem('activities', JSON.stringify(state.activities));

            updateActivitiesList();
            updateWeekStats();
            closeActivityModal();
        }

        function updateActivitiesList() {
            const container = document.getElementById('activities-list');
            let allActivities = [...state.activities, ...state.stravaActivities]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Apply type filter
            const typeFilter = document.getElementById('filter-type')?.value || 'all';
            if (typeFilter !== 'all') {
                allActivities = allActivities.filter(a => a.type === typeFilter);
            }

            // Apply period filter
            const periodFilter = document.getElementById('filter-period')?.value || 'all';
            const now = new Date();
            if (periodFilter !== 'all') {
                let startDate;
                switch(periodFilter) {
                    case 'week':
                        startDate = new Date(now);
                        const dow = now.getDay();
                        startDate.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1));
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case '3months':
                        startDate = new Date(now);
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                    case '6months':
                        startDate = new Date(now);
                        startDate.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                }
                if (startDate) {
                    startDate.setHours(0,0,0,0);
                    allActivities = allActivities.filter(a => new Date(a.date) >= startDate);
                }
            }

            if (allActivities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>Keine Aktivit√§ten gefunden</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">${state.stravaConnected ? '√Ñndere den Filter oder synchronisiere Strava' : 'Verbinde Strava oder f√ºge manuell hinzu'}</p>
                        ${!state.stravaConnected ? `<button class="strava-connect" onclick="connectStrava()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                            Mit Strava verbinden
                        </button>` : ''}
                    </div>`;
                return;
            }

            const typeIcons = { run: 'üèÉ', bike: 'üö¥', swim: 'üèä', strength: 'üí™', mobility: 'üßò', walk: 'üö∂', crosstrainer: 'üèãÔ∏è', padel: 'üéæ', basketball: 'üèÄ' };
            const typeNames = { run: 'Lauf', bike: 'Radfahren', swim: 'Schwimmen', strength: 'Krafttraining', mobility: 'Mobility', walk: 'Gehen', crosstrainer: 'Crosstrainer', padel: 'Padel', basketball: 'Basketball' };
            const kneeIcons = { green: 'üü¢', yellow: 'üü°', red: 'üî¥' };
            const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

            // Group by month
            const grouped = {};
            allActivities.forEach(a => {
                const d = new Date(a.date);
                const key = `${d.getFullYear()}-${d.getMonth()}`;
                if (!grouped[key]) {
                    grouped[key] = { label: `${monthNames[d.getMonth()]} ${d.getFullYear()}`, activities: [] };
                }
                grouped[key].activities.push(a);
            });

            // Render grouped
            let html = '';
            Object.values(grouped).forEach(group => {
                html += `<div style="font-weight: 600; color: var(--accent); margin: 1rem 0 0.5rem; font-size: 0.9rem;">${group.label}</div>`;
                group.activities.forEach(a => {
                    html += `
                        <div class="activity-card">
                            <div class="activity-header">
                                <div class="activity-type">
                                    <span class="activity-name">${a.name || typeNames[a.type] || a.type}</span>
                                    ${a.kneeStatus ? `<span>${kneeIcons[a.kneeStatus] || ''}</span>` : ''}
                                </div>
                                <div class="activity-date">${new Date(a.date).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric' })}</div>
                            </div>
                            <div class="activity-stats" style="flex-wrap: wrap;">
                                ${a.distance ? `<span class="activity-stat">üìè ${parseFloat(a.distance).toFixed(1)} km</span>` : ''}
                                ${a.durationSeconds ? `<span class="activity-stat">‚è±Ô∏è ${formatDuration(a.durationSeconds)}</span>` : (a.duration ? `<span class="activity-stat">‚è±Ô∏è ${a.duration} min</span>` : '')}
                                ${a.averagePace ? `<span class="activity-stat">üèÉ ${a.averagePace}</span>` : ''}
                                ${a.heartRate ? `<span class="activity-stat">‚ù§Ô∏è ${Math.round(a.heartRate)} bpm</span>` : ''}
                                ${a.elevation ? `<span class="activity-stat">‚õ∞Ô∏è ${Math.round(a.elevation)}m</span>` : ''}
                                ${a.calories ? `<span class="activity-stat">üî• ${a.calories} kcal</span>` : ''}
                                ${a.cadence ? `<span class="activity-stat">üëü ${Math.round(a.cadence)} spm</span>` : ''}
                                ${a.source === 'strava' ? '<span class="activity-stat" style="color: #fc4c02; font-size: 0.75rem;">Strava</span>' : ''}
                            </div>
                        </div>`;
                });
            });

            container.innerHTML = html;
        }

        function updateWeekStats() {
            const today = new Date();
            const weekStart = new Date(today);
            // Start from Monday (getDay() returns 0 for Sunday)
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0
            weekStart.setDate(today.getDate() - diff);
            weekStart.setHours(0, 0, 0, 0);

            const allActivities = [...state.activities, ...state.stravaActivities];

            // Filter activities from this week (all types, not just runs)
            const weekActivities = allActivities.filter(a => new Date(a.date) >= weekStart);

            // Calculate km (parse as float to handle string values, with NaN protection)
            const weekKmRaw = weekActivities
                .filter(a => a.type === 'run')
                .reduce((sum, a) => {
                    const dist = parseFloat(a.distance);
                    return sum + (isNaN(dist) ? 0 : dist);
                }, 0);
            const weekKm = isNaN(weekKmRaw) ? 0 : weekKmRaw;

            // Calculate total activity minutes this week (all types)
            const weekMinutes = weekActivities.reduce((sum, a) => {
                const dur = parseInt(a.duration);
                return sum + (isNaN(dur) ? 0 : dur);
            }, 0);

            document.getElementById('week-km').innerHTML = `${(Number(weekKm) || 0).toFixed(1)} <span class="stat-unit">km</span>`;
            document.getElementById('week-trend').textContent = `${weekMinutes} min Aktivit√§t`;

            // Show activity minutes in second card instead of 4-week average
            document.getElementById('month-km').innerHTML = `${weekMinutes} <span class="stat-unit">min</span>`;
            document.getElementById('month-trend').textContent = 'Aktivit√§t diese Woche';
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW:', err));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (state.hasSeenSplash) document.getElementById('splash').classList.add('hidden');
            updateCountdown();
            updateKneeDisplay();
            loadMessages();
            updateChatHeader();
            updateActivitiesList();
            updateWeekStats();
            updateNutritionDisplay();
            updateStravaUI();
            updateGarminUI();
            updateReadinessDisplay();

            // Check for Strava OAuth callback
            await handleStravaCallback();

            // Auto-refresh Strava activities if connected
            if (state.stravaConnected) {
                fetchStravaActivities();
            }

            const input = document.getElementById('chat-input');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            });
        });
    </script>
    <div class="toast" id="toast"></div>
</body>
</html>
